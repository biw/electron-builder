{"version":3,"file":"PublishManagerTest.js","sourceRoot":"","sources":["../src/PublishManagerTest.ts"],"names":[],"mappings":"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","sourcesContent":["import { GenericServerOptions, GithubOptions, KeygenOptions, SpacesOptions } from \"builder-util-runtime\"\nimport { Arch, createTargets, Platform } from \"electron-builder\"\nimport { outputFile } from \"fs-extra\"\nimport * as path from \"path\"\nimport { assertThat } from \"./helpers/fileAssert\"\nimport { app, checkDirContents } from \"./helpers/packTester\"\n\nfunction spacesPublisher(publishAutoUpdate = true): SpacesOptions {\n  return {\n    provider: \"spaces\",\n    name: \"mySpaceName\",\n    region: \"nyc3\",\n    publishAutoUpdate,\n  }\n}\n\nfunction githubPublisher(repo: string): GithubOptions {\n  return {\n    provider: \"github\",\n    repo,\n  }\n}\n\nfunction genericPublisher(url: string): GenericServerOptions {\n  return {\n    provider: \"generic\",\n    url,\n  }\n}\n\nfunction keygenPublisher(): KeygenOptions {\n  return {\n    provider: \"keygen\",\n    product: \"43981278-96e7-47de-b8c2-98d59987206b\",\n    account: \"cdecda36-3ef0-483e-ad88-97e7970f3149\",\n  }\n}\n\ntest.ifNotWindows.ifDevOrLinuxCi(\"generic, github and spaces\", ({ expect }) =>\n  app(expect, {\n    targets: Platform.MAC.createTarget(\"zip\", Arch.x64),\n    config: {\n      generateUpdatesFilesForAllChannels: true,\n      mac: {\n        electronUpdaterCompatibility: \">=2.16\",\n      },\n      publish: [genericPublisher(\"https://example.com/downloads\"), githubPublisher(\"foo/foo\"), spacesPublisher()],\n    },\n  })\n)\n\ntest.ifNotWindows.ifDevOrLinuxCi(\"github and spaces (publishAutoUpdate)\", ({ expect }) =>\n  app(expect, {\n    targets: Platform.LINUX.createTarget(\"AppImage\"),\n    config: {\n      mac: {\n        electronUpdaterCompatibility: \">=2.16\",\n      },\n      publish: [githubPublisher(\"foo/foo\"), spacesPublisher(false)],\n    },\n  })\n)\n\ntest.ifMac(\"mac artifactName \", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"zip\", Arch.x64),\n      config: {\n        // tslint:disable-next-line:no-invalid-template-strings\n        artifactName: \"${productName}_${version}_${os}.${ext}\",\n        mac: {\n          electronUpdaterCompatibility: \">=2.16\",\n        },\n        publish: [spacesPublisher(), keygenPublisher()],\n      },\n    },\n    {\n      publish: undefined,\n    }\n  )\n)\n\n// otherwise test \"os macro\" always failed for pull requests\nprocess.env.PUBLISH_FOR_PULL_REQUEST = \"true\"\n\ntest.ifNotWindows(\"os macro\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: createTargets([Platform.LINUX, Platform.MAC], \"zip\"),\n      config: {\n        publish: {\n          provider: \"s3\",\n          bucket: \"my bucket\",\n          // tslint:disable-next-line:no-invalid-template-strings\n          path: \"${channel}/${os}\",\n        },\n      },\n    },\n    {\n      publish: \"always\",\n      projectDirCreated: async projectDir => {\n        process.env.__TEST_S3_PUBLISHER__ = path.join(projectDir, \"dist/s3\")\n      },\n      packed: async context => {\n        const dir = path.join(context.projectDir, \"dist/s3\")\n        await assertThat(expect, dir).isDirectory()\n        await checkDirContents(expect, dir)\n      },\n    }\n  )\n)\n\n// disable on ifNotCi for now - slow on CircleCI\n// error should be ignored because publish: never\n// https://github.com/electron-userland/electron-builder/issues/2670\ntest.ifNotCi(\"dotted s3 bucket\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: createTargets([Platform.LINUX], \"zip\"),\n      config: {\n        publish: {\n          provider: \"s3\",\n          bucket: \"bucket.dotted.name\",\n        },\n      },\n    },\n    {\n      publish: \"never\",\n    }\n  )\n)\n\n// https://github.com/electron-userland/electron-builder/issues/3261\ntest.ifNotWindows(\"custom provider\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: createTargets([Platform.LINUX], \"deb\"),\n      config: {\n        publish: {\n          provider: \"custom\",\n          boo: \"foo\",\n        },\n      },\n    },\n    {\n      publish: \"never\",\n      projectDirCreated: projectDir =>\n        outputFile(\n          path.join(projectDir, \"build/electron-publisher-custom.js\"),\n          `class Publisher {\n    async upload(task) {\n    }\n  }\n\n  module.exports = Publisher`\n        ),\n    }\n  )\n)\n"]}