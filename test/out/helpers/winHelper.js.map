{"version":3,"file":"winHelper.js","sourceRoot":"","sources":["../../src/helpers/winHelper.ts"],"names":[],"mappings":"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","sourcesContent":["import { readAsarJson } from \"app-builder-lib/out/asar/asar\"\nimport { walk } from \"builder-util\"\nimport { Arch, Platform } from \"electron-builder\"\nimport { outputFile } from \"fs-extra\"\nimport * as fs from \"fs/promises\"\nimport { load } from \"js-yaml\"\nimport * as path from \"path\"\nimport { assertThat } from \"./fileAssert\"\nimport { PackedContext } from \"./packTester\"\nimport { diff, WineManager } from \"./wine\"\nimport { ExpectStatic } from \"vitest\"\n\nexport async function expectUpdateMetadata(expect: ExpectStatic, context: PackedContext, arch: Arch = Arch.ia32, requireCodeSign: boolean = false): Promise<void> {\n  const data = load(await fs.readFile(path.join(context.getResources(Platform.WINDOWS, arch), \"app-update.yml\"), \"utf-8\")) as any\n  if (requireCodeSign) {\n    expect(data.publisherName).toEqual([\"Foo, Inc\"])\n    delete data.publisherName\n  }\n\n  expect(data).toMatchSnapshot()\n}\n\nexport async function checkHelpers(expect: ExpectStatic, resourceDir: string, isPackElevateHelper: boolean) {\n  const elevateHelperExecutable = path.join(resourceDir, \"elevate.exe\")\n  if (isPackElevateHelper) {\n    await assertThat(expect, elevateHelperExecutable).isFile()\n  } else {\n    await assertThat(expect, elevateHelperExecutable).doesNotExist()\n  }\n}\n\nexport async function doTest(\n  expect: ExpectStatic,\n  outDir: string,\n  perUser: boolean,\n  productFilename = \"TestApp Setup\",\n  name = \"TestApp\",\n  menuCategory: string | null = null,\n  packElevateHelper = true\n) {\n  if (process.env.DO_WINE !== \"true\") {\n    return Promise.resolve()\n  }\n\n  const wine = new WineManager()\n  await wine.prepare()\n  const driveC = path.join(wine.wineDir!, \"drive_c\")\n  const driveCWindows = path.join(wine.wineDir!, \"drive_c\", \"windows\")\n  const perUserTempDir = path.join(wine.userDir!, \"Temp\")\n  const walkFilter = (it: string) => {\n    return it !== driveCWindows && it !== perUserTempDir\n  }\n\n  function listFiles() {\n    return walk(driveC, null, { consume: walkFilter })\n  }\n\n  let fsBefore = await listFiles()\n\n  await wine.exec(path.join(outDir, `${productFilename} Setup 1.1.0.exe`), \"/S\")\n\n  let instDir = perUser ? path.join(wine.userDir!, \"Local Settings\", \"Application Data\", \"Programs\") : path.join(driveC, \"Program Files\")\n  if (menuCategory != null) {\n    instDir = path.join(instDir, menuCategory)\n  }\n\n  const appAsar = path.join(instDir, name, \"resources\", \"app.asar\")\n  expect(await readAsarJson(appAsar, \"package.json\")).toMatchObject({\n    name,\n  })\n\n  if (!perUser) {\n    let startMenuDir = path.join(driveC, \"users\", \"Public\", \"Start Menu\", \"Programs\")\n    if (menuCategory != null) {\n      startMenuDir = path.join(startMenuDir, menuCategory)\n    }\n    await assertThat(expect, path.join(startMenuDir, `${productFilename}.lnk`)).isFile()\n  }\n\n  if (packElevateHelper) {\n    await assertThat(expect, path.join(instDir, name, \"resources\", \"elevate.exe\")).isFile()\n  } else {\n    await assertThat(expect, path.join(instDir, name, \"resources\", \"elevate.exe\")).doesNotExist()\n  }\n\n  let fsAfter = await listFiles()\n\n  let fsChanges = diff(fsBefore, fsAfter, driveC)\n  expect(fsChanges.added).toMatchSnapshot()\n  expect(fsChanges.deleted).toEqual([])\n\n  // run installer again to test uninstall\n  const appDataFile = path.join(wine.userDir!, \"Application Data\", name, \"doNotDeleteMe\")\n  await outputFile(appDataFile, \"app data must be not removed\")\n  fsBefore = await listFiles()\n  await wine.exec(path.join(outDir, `${productFilename} Setup 1.1.0.exe`), \"/S\")\n  fsAfter = await listFiles()\n\n  fsChanges = diff(fsBefore, fsAfter, driveC)\n  expect(fsChanges.added).toEqual([])\n  expect(fsChanges.deleted).toEqual([])\n\n  await assertThat(expect, appDataFile).isFile()\n\n  await wine.exec(path.join(outDir, `${productFilename} Setup 1.1.0.exe`), \"/S\", \"--delete-app-data\")\n  await assertThat(expect, appDataFile).doesNotExist()\n}\n"]}