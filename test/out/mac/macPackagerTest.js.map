{"version":3,"file":"macPackagerTest.js","sourceRoot":"","sources":["../../src/mac/macPackagerTest.ts"],"names":[],"mappings":"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","sourcesContent":["import { copyOrLinkFile } from \"builder-util\"\nimport { Arch, createTargets, DIR_TARGET, Platform } from \"electron-builder\"\nimport * as fs from \"fs/promises\"\nimport * as path from \"path\"\nimport { assertThat } from \"../helpers/fileAssert\"\nimport { app, appThrows, assertPack, checkDirContents, platform } from \"../helpers/packTester\"\nimport { verifySmartUnpack } from \"../helpers/verifySmartUnpack\"\n\ntest.ifMac(\"two-package\", ({ expect }) =>\n  assertPack(\n    expect,\n    \"test-app\",\n    {\n      targets: createTargets([Platform.MAC], null, \"all\"),\n      config: {\n        extraMetadata: {\n          repository: \"foo/bar\",\n        },\n        downloadAlternateFFmpeg: true,\n        mac: {\n          electronUpdaterCompatibility: \">=2.16\",\n          electronLanguages: [\"bn\", \"en\"],\n          timestamp: undefined,\n          notarize: false,\n        },\n        dmg: {\n          title: \"Foo1\",\n        },\n        //tslint:disable-next-line:no-invalid-template-strings\n        artifactName: \"${name}-${version}-${os}-${arch}.${ext}\",\n        electronFuses: {\n          runAsNode: true,\n          enableCookieEncryption: true,\n          enableNodeOptionsEnvironmentVariable: true,\n          enableNodeCliInspectArguments: true,\n          enableEmbeddedAsarIntegrityValidation: true,\n          onlyLoadAppFromAsar: true,\n          loadBrowserProcessSpecificV8Snapshot: true,\n          grantFileProtocolExtraPrivileges: undefined, // unsupported on current electron version in our tests\n        },\n      },\n    },\n    {\n      signed: true,\n      checkMacApp: async appDir => {\n        const resources = await fs.readdir(path.join(appDir, \"Contents\", \"Resources\"))\n        expect(resources.filter(it => !it.startsWith(\".\")).sort()).toMatchSnapshot()\n\n        const electronFrameworkResources = await fs.readdir(path.join(appDir, \"Contents\", \"Frameworks\", \"Electron Framework.framework\", \"Resources\"))\n        expect(electronFrameworkResources.filter(it => !it.startsWith(\".\")).sort()).toMatchSnapshot()\n      },\n    }\n  )\n)\n\ntest.ifMac(\"one-package\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(undefined, Arch.x64),\n      config: {\n        appId: \"bar\",\n        publish: {\n          provider: \"generic\",\n          //tslint:disable-next-line:no-invalid-template-strings\n          url: \"https://develar.s3.amazonaws.com/test/${os}/${arch}\",\n        },\n        downloadAlternateFFmpeg: false,\n        dmg: {\n          title: \"Bar2\",\n        },\n        mac: {\n          // test appId per platform\n          appId: \"foo\",\n          extendInfo: {\n            LSUIElement: true,\n            CFBundleDocumentTypes: [\n              {\n                CFBundleTypeName: \"Folders\",\n                CFBundleTypeRole: \"Editor\",\n                LSItemContentTypes: [\"public.folder\"],\n              },\n            ],\n          },\n          minimumSystemVersion: \"10.12.0\",\n          fileAssociations: [\n            {\n              ext: \"foo\",\n              name: \"Foo\",\n              role: \"Viewer\",\n            },\n            {\n              ext: \"boo\",\n              name: \"Boo\",\n              role: \"Shell\",\n              rank: \"Owner\",\n              isPackage: true,\n            },\n            {\n              ext: \"bar\",\n              name: \"Bar\",\n              role: \"Shell\",\n              rank: \"Default\",\n              // If I specify `fileAssociations.icon` as `build/foo.icns` will it know to use `build/foo.ico` for Windows?\n              icon: \"someFoo.ico\",\n            },\n          ],\n        },\n      },\n    },\n    {\n      signed: false,\n      projectDirCreated: projectDir =>\n        Promise.all([\n          copyOrLinkFile(path.join(projectDir, \"build\", \"icon.icns\"), path.join(projectDir, \"build\", \"foo.icns\")),\n          copyOrLinkFile(path.join(projectDir, \"build\", \"icon.icns\"), path.join(projectDir, \"build\", \"someFoo.icns\")),\n        ]),\n      checkMacApp: async (appDir, info) => {\n        await assertThat(expect, path.join(appDir, \"Contents\", \"Resources\", \"foo.icns\")).isFile()\n        await assertThat(expect, path.join(appDir, \"Contents\", \"Resources\", \"someFoo.icns\")).isFile()\n      },\n    }\n  )\n)\n\ntest.ifMac(\"yarn two package.json w/ native module\", ({ expect }) =>\n  assertPack(\n    expect,\n    \"test-app-two-native-modules\",\n    {\n      targets: Platform.MAC.createTarget(\"zip\", Arch.universal),\n      config: {\n        npmRebuild: true,\n        nativeRebuilder: \"sequential\",\n        files: [\"!**/*.stamp\", \"!**/*.Makefile\"],\n      },\n    },\n    {\n      signed: false,\n      packed: async context => await verifySmartUnpack(expect, context.getResources(Platform.MAC, Arch.universal)),\n    }\n  )\n)\n\ntest.ifMac(\"electronDist\", ({ expect }) =>\n  appThrows(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(DIR_TARGET, Arch.x64),\n      config: {\n        electronDist: \"foo\",\n      },\n    },\n    {},\n    error => expect(error.message).toContain(\"Please provide a valid path to the Electron zip file, cache directory, or electron build directory.\")\n  )\n)\n\ntest.ifWinCi(\"Build macOS on Windows is not supported\", ({ expect }) => appThrows(expect, platform(Platform.MAC)))\n\ntest(\"multiple asar resources\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"zip\", Arch.x64),\n      config: {\n        extraResources: [\n          { from: \"build\", to: \"./\", filter: \"*.asar\" },\n          { from: \"build/subdir\", to: \"./subdir\", filter: \"*.asar\" },\n        ],\n        electronLanguages: \"en\",\n      },\n    },\n    {\n      signed: true,\n      projectDirCreated: async projectDir => {\n        await fs.mkdir(path.join(projectDir, \"build\", \"subdir\"))\n        await fs.copyFile(path.join(projectDir, \"build\", \"extraAsar.asar\"), path.join(projectDir, \"build\", \"subdir\", \"extraAsar2.asar\"))\n      },\n      checkMacApp: async (appDir, info) => {\n        await checkDirContents(expect, path.join(appDir, \"Contents\", \"Resources\"))\n      },\n    }\n  ))\n"]}