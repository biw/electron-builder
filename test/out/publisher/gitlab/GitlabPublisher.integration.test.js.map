{"version":3,"file":"GitlabPublisher.integration.test.js","sourceRoot":"","sources":["../../../src/publisher/gitlab/GitlabPublisher.integration.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch } from \"builder-util\"\nimport { CancellationToken } from \"builder-util-runtime\"\nimport { GitlabPublisher, PublishContext } from \"electron-publish\"\nimport { afterAll, beforeEach, describe, expect, test } from \"vitest\"\nimport { GitlabTestFixtures } from \"./GitlabTestFixtures\"\nimport { GitlabTestHelper } from \"./GitlabTestHelper\"\n\n/**\n * GitLab Publisher Integration Tests\n *\n * Streamlined integration tests for GitlabPublisher core functionality.\n *\n * Prerequisites:\n * - GITLAB_TOKEN environment variable with valid GitLab personal access token\n * - GITLAB_TEST_PROJECT_ID for test project (default: 72170733)\n *\n * Coverage:\n * - Authentication validation\n * - Upload methods: project_upload and generic_package\n * - Release creation and asset linking\n *\n * Features:\n * - Automatic cleanup via afterAll hook\n * - Minimal API calls for CI efficiency\n */\n\nfunction isAuthError(error: unknown): boolean {\n  const errorMessage = (error as Error)?.message || (error as any)?.description?.message || String(error)\n  return GitlabTestFixtures.ERROR_PATTERNS.auth.test(errorMessage)\n}\n\n/**\n * Cleans up test releases, preserving [v1.0.0, v1.1.0] baseline releases\n */\nasync function cleanupExistingReleases(): Promise<void> {\n  const token = process.env.GITLAB_TOKEN\n  if (!token) {\n    // No GitLab token available for cleanup\n    return\n  }\n\n  try {\n    const helper = new GitlabTestHelper()\n    const releases = await helper.getAllReleases()\n\n    // Keep [v1.0.0, v1.1.0] baseline releases\n    const protectedReleases = [\"v1.0.0\", \"1.0.0\", \"v1.1.0\", \"1.1.0\"]\n    const releasesToDelete = releases.filter((release: any) => !protectedReleases.includes(release.tag_name))\n\n    if (releasesToDelete.length === 0) {\n      // No releases to cleanup\n      return\n    }\n\n    // Delete releases, tags, and assets\n    const cleanupPromises = releasesToDelete.map(async (release: any) => {\n      try {\n        const versionId = release.tag_name\n        await helper.deleteUploadedAssets(versionId)\n        await helper.deleteReleaseAndTag(versionId)\n        // Cleaned up release: ${versionId}\n      } catch (_e: unknown) {\n        // Failed to cleanup release ${release.tag_name}\n      }\n    })\n\n    await Promise.allSettled(cleanupPromises)\n    // Cleanup completed. Deleted ${releasesToDelete.length} releases.\n  } catch (_e: unknown) {\n    // Failed to perform cleanup\n  }\n}\n\ndescribe.sequential(\"GitLab Publisher - Integration Tests\", () => {\n  let publishContext: PublishContext\n  let gitlabHelper: GitlabTestHelper\n  let testId: string\n\n  beforeEach(() => {\n    testId = Date.now().toString()\n    publishContext = {\n      cancellationToken: new CancellationToken(),\n      progress: null,\n    }\n    gitlabHelper = new GitlabTestHelper()\n  })\n\n  afterAll(async () => {\n    await cleanupExistingReleases()\n  }, 120000)\n\n  // Helper to create a publisher with unique version\n  function createPublisher(options: any = {}): GitlabPublisher {\n    const uniqueVersion = `${GitlabTestFixtures.VERSIONS.randomVersion()}.${testId}`\n\n    return new GitlabPublisher(\n      publishContext,\n      GitlabTestFixtures.createOptions({\n        ...options,\n        token: undefined, // Use environment token\n      }),\n      uniqueVersion\n    )\n  }\n\n  describe.sequential(\"Authentication\", () => {\n    test(\"should reject invalid token\", async () => {\n      const publisher = new GitlabPublisher(\n        publishContext,\n        GitlabTestFixtures.createOptions({\n          token: GitlabTestFixtures.TOKENS.invalid,\n        }),\n        `${GitlabTestFixtures.VERSIONS.randomVersion()}.${testId}`\n      )\n\n      try {\n        await publisher.upload({ file: GitlabTestFixtures.ICON_PATH, arch: Arch.x64 })\n        throw new Error(\"Expected authentication error\")\n      } catch (error: unknown) {\n        expect(isAuthError(error), `Error: ${(error as Error).message}`).toBe(true)\n      }\n    }, 15000)\n  })\n\n  describe.sequential(\"File Upload\", () => {\n    test.skipIf(!process.env.GITLAB_TOKEN)(\n      \"should upload via project_upload, create release and link assets\",\n      async () => {\n        const publisher = createPublisher()\n        await publisher.upload({ file: GitlabTestFixtures.ICON_PATH, arch: Arch.x64 })\n\n        const tag = (publisher as any).tag\n        const release = await gitlabHelper.getRelease(tag)\n        expect(release).toBeTruthy()\n        expect(GitlabTestFixtures.validateReleaseStructure(release)).toBe(true)\n\n        const assets = release?.assets\n        expect(assets?.links?.length).toBeGreaterThan(0)\n        expect(GitlabTestFixtures.validateAssetLinkStructure(assets?.links[0], \"project_upload\")).toBe(true)\n      },\n      60000\n    )\n\n    test.skipIf(!process.env.GITLAB_TOKEN)(\n      \"should upload via generic_package, create release and link assets\",\n      async () => {\n        const publisher = createPublisher({ uploadTarget: \"generic_package\" })\n        await publisher.upload({ file: GitlabTestFixtures.ICON_PATH, arch: Arch.x64 })\n\n        const tag = (publisher as any).tag\n        const release = await gitlabHelper.getRelease(tag)\n        expect(release).toBeTruthy()\n        expect(GitlabTestFixtures.validateReleaseStructure(release)).toBe(true)\n\n        const assets = release?.assets\n        expect(assets?.links?.length).toBeGreaterThan(0)\n        expect(GitlabTestFixtures.validateAssetLinkStructure(assets?.links[0], \"generic_package\")).toBe(true)\n      },\n      60000\n    )\n  })\n})\n"]}