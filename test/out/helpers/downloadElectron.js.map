{"version":3,"file":"downloadElectron.js","sourceRoot":"","sources":["../../src/helpers/downloadElectron.ts"],"names":[],"mappings":"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","sourcesContent":["import { isCI as isCi } from \"ci-info\"\nimport * as fs from \"fs/promises\"\nimport * as path from \"path\"\nimport { gte } from \"semver\"\nimport { ELECTRON_VERSION, getElectronCacheDir } from \"./testConfig\"\n\nconst executeAppBuilder: (options: any) => Promise<any> = require(path.join(__dirname, \"../../..\", \"packages/builder-util\")).executeAppBuilder\n\nexport async function deleteOldElectronVersion(): Promise<any> {\n  // on CircleCi no need to clean manually\n  if (process.env.CIRCLECI || !isCi) {\n    return\n  }\n\n  const cacheDir = getElectronCacheDir()\n  let files: Array<string>\n  try {\n    files = await fs.readdir(cacheDir)\n  } catch (e: any) {\n    if (e.code === \"ENOENT\") {\n      return\n    } else {\n      throw e\n    }\n  }\n  return await Promise.all(\n    files.map(file => {\n      if (file.endsWith(\".zip\") && !file.includes(ELECTRON_VERSION)) {\n        console.log(`Remove old electron ${file}`)\n        return fs.unlink(path.join(cacheDir, file))\n      }\n      return Promise.resolve(null)\n    })\n  )\n}\n\nexport function downloadAllRequiredElectronVersions(): Promise<any> {\n  const platforms = process.platform === \"win32\" ? [\"win32\"] : [\"darwin\", \"linux\", \"win32\"]\n  if (process.platform === \"darwin\") {\n    platforms.push(\"mas\")\n  }\n\n  const versions: Array<any> = []\n  for (const platform of platforms) {\n    const archs: string[] =\n      platform === \"mas\" || platform === \"darwin\"\n        ? [\"x64\"]\n        : platform === \"win32\"\n          ? [\"ia32\", \"x64\"]\n          : require(`${path.join(__dirname, \"../../..\")}/packages/builder-util/out/util`).getArchCliNames()\n    for (const arch of archs) {\n      if (gte(ELECTRON_VERSION, \"19.0.0\") && platform === \"linux\" && arch === \"ia32\") {\n        // Chromium dropped support for ia32 linux binaries in 102.0.4999.0\n        // https://www.electronjs.org/docs/latest/breaking-changes#removed-ia32-linux-binaries\n        continue\n      }\n      versions.push({\n        version: ELECTRON_VERSION,\n        arch,\n        platform,\n      })\n    }\n  }\n  return executeAppBuilder([\"download-electron\", \"--configuration\", JSON.stringify(versions)])\n}\n\nif (require.main === module) {\n  downloadAllRequiredElectronVersions().catch(error => {\n    console.error((error.stack || error).toString())\n    process.exitCode = -1\n  })\n}\n"]}