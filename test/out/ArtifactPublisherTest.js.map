{"version":3,"file":"ArtifactPublisherTest.js","sourceRoot":"","sources":["../src/ArtifactPublisherTest.ts"],"names":[],"mappings":"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","sourcesContent":["import { Platform } from \"app-builder-lib\"\nimport { createPublisher } from \"app-builder-lib/out/publish/PublishManager\"\nimport { Arch } from \"builder-util\"\nimport { BitbucketOptions, CancellationToken, HttpError, KeygenOptions, S3Options, SpacesOptions } from \"builder-util-runtime\"\nimport { publishArtifactsWithOptions } from \"electron-builder\"\nimport { BitbucketPublisher, GitHubPublisher, KeygenPublisher, PublishContext } from \"electron-publish\"\nimport * as path from \"path\"\nimport { ExpectStatic } from \"vitest\"\n\nfunction getRandomInt(min: number, max: number) {\n  return Math.floor(Math.random() * (max - min + 1)) + min\n}\n\nfunction versionNumber() {\n  return `${getRandomInt(0, 99)}.${getRandomInt(0, 99)}.${getRandomInt(0, 99)}`\n}\n\n//noinspection SpellCheckingInspection\nconst token = Buffer.from(\"Y2Y5NDdhZDJhYzJlMzg1OGNiNzQzYzcwOWZhNGI0OTk2NWQ4ZDg3Yg==\", \"base64\").toString()\nconst iconPath = path.join(__dirname, \"..\", \"fixtures\", \"test-app\", \"build\", \"icon.icns\")\nconst icoPath = path.join(__dirname, \"..\", \"fixtures\", \"test-app\", \"build\", \"icon.ico\")\n\nconst publishContext: PublishContext = {\n  cancellationToken: new CancellationToken(),\n  progress: null,\n}\n\ntest(\"GitHub unauthorized\", async ({ expect }) => {\n  try {\n    await new GitHubPublisher(publishContext, { provider: \"github\", owner: \"actperepo\", repo: \"ecb2\", token: \"incorrect token\" }, versionNumber())._release.value\n  } catch (e: any) {\n    expect(e.message).toMatch(/(Bad credentials|Unauthorized|API rate limit exceeded)/)\n    return\n  }\n\n  throw new Error(\"must be error\")\n})\n\nfunction isApiRateError(e: Error): boolean {\n  if (e.name === \"HttpError\") {\n    const description = (e as HttpError).description\n    return description.message != null && description.message.includes(\"API rate limit exceeded\")\n  } else {\n    return false\n  }\n}\n\nfunction testAndIgnoreApiRate(name: string, testFunction: (expect: ExpectStatic) => Promise<any>) {\n  test.skip(name, async ({ expect }) => {\n    try {\n      await testFunction(expect)\n    } catch (e: any) {\n      if (isApiRateError(e)) {\n        console.warn(e.description.message)\n      } else {\n        throw e\n      }\n    }\n  })\n}\n\ntestAndIgnoreApiRate(\"GitHub upload\", async () => {\n  const publisher = new GitHubPublisher(publishContext, { provider: \"github\", owner: \"actperepo\", repo: \"ecb2\", token }, versionNumber())\n  try {\n    await publisher.upload({ file: iconPath, arch: Arch.x64 })\n    // test overwrite\n    await publisher.upload({ file: iconPath, arch: Arch.x64 })\n  } finally {\n    await publisher.deleteRelease()\n  }\n})\n\ntest.ifEnv(process.env.AWS_ACCESS_KEY_ID != null && process.env.AWS_SECRET_ACCESS_KEY != null)(\"S3 upload\", async () => {\n  const publisher = await createPublisher(publishContext, \"0.0.1\", { provider: \"s3\", bucket: \"electron-builder-test\" } as S3Options, {}, {} as any)\n  await publisher!.upload({ file: iconPath, arch: Arch.x64 })\n  // test overwrite\n  await publisher!.upload({ file: iconPath, arch: Arch.x64 })\n})\n\ntest.ifEnv(process.env.DO_KEY_ID != null && process.env.DO_SECRET_KEY != null)(\"DO upload\", async () => {\n  const configuration: SpacesOptions = {\n    provider: \"spaces\",\n    name: \"electron-builder-test\",\n    region: \"nyc3\",\n  }\n  const publisher = await createPublisher(publishContext, \"0.0.1\", configuration, {}, {} as any)\n  await publisher!.upload({ file: iconPath, arch: Arch.x64 })\n  // test overwrite\n  await publisher!.upload({ file: iconPath, arch: Arch.x64 })\n})\n\ntestAndIgnoreApiRate(\"prerelease\", async expect => {\n  const publisher = new GitHubPublisher(publishContext, { provider: \"github\", owner: \"actperepo\", repo: \"ecb2\", token, releaseType: \"prerelease\" }, versionNumber())\n  try {\n    await publisher.upload({ file: iconPath, arch: Arch.x64 })\n    const r = await publisher.getRelease()\n    expect(r).toMatchObject({\n      prerelease: true,\n      draft: false,\n    })\n  } finally {\n    await publisher.deleteRelease()\n  }\n})\n\ntestAndIgnoreApiRate(\"GitHub upload org\", async () => {\n  //noinspection SpellCheckingInspection\n  const publisher = new GitHubPublisher(publishContext, { provider: \"github\", owner: \"builder-gh-test\", repo: \"darpa\", token }, versionNumber())\n  try {\n    await publisher.upload({ file: iconPath, arch: Arch.x64 })\n  } finally {\n    await publisher.deleteRelease()\n  }\n})\n\ntest.ifEnv(process.env.KEYGEN_TOKEN)(\"Keygen upload\", async () => {\n  const publisher = new KeygenPublisher(\n    publishContext,\n    {\n      provider: \"keygen\",\n      // electron-builder-test\n      product: process.env.KEYGEN_PRODUCT || \"43981278-96e7-47de-b8c2-98d59987206b\",\n      account: process.env.KEYGEN_ACCOUNT || \"cdecda36-3ef0-483e-ad88-97e7970f3149\",\n      platform: Platform.MAC.name,\n    } as KeygenOptions,\n    versionNumber()\n  )\n  const [releaseId] = await Promise.all([\n    publisher.upload({ file: iconPath, arch: Arch.x64 }),\n    // test parallel artifact uploads for the same release\n    publisher.upload({ file: icoPath, arch: Arch.x64 }),\n  ])\n\n  await publisher.deleteRelease(releaseId)\n})\n\ntest.ifEnv(process.env.BITBUCKET_TOKEN)(\"Bitbucket upload\", async () => {\n  const timeout = 0\n  const config: BitbucketOptions = {\n    provider: \"bitbucket\",\n    owner: \"mike-m\",\n    slug: \"electron-builder-test\",\n    timeout,\n  }\n  const publisher = new BitbucketPublisher(publishContext, config)\n  const filename = await publisher.upload({ file: iconPath, arch: Arch.x64, timeout })\n  await publisher.deleteRelease(filename)\n\n  const uploadTasks: any = await publishArtifactsWithOptions([{ file: icoPath, arch: null }], undefined, undefined, [config])\n  for (const task of uploadTasks) {\n    await publisher.deleteRelease(task.file)\n  }\n})\n\ntest.ifEnv(process.env.BITBUCKET_TOKEN)(\"Bitbucket upload\", async ({ expect }) => {\n  const timeout = 100\n  const publisher = new BitbucketPublisher(publishContext, {\n    provider: \"bitbucket\",\n    owner: \"mike-m\",\n    slug: \"electron-builder-test\",\n    timeout,\n  } as BitbucketOptions)\n  expect(await publisher.upload({ file: iconPath, arch: Arch.x64, timeout })).toThrowError(\"Request timed out\")\n})\n"]}