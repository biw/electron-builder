{"version":3,"file":"macArchiveTest.js","sourceRoot":"","sources":["../../src/mac/macArchiveTest.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, exec } from \"builder-util\"\nimport { parseXml } from \"builder-util-runtime\"\nimport { Platform } from \"electron-builder\"\nimport { outputFile } from \"fs-extra\"\nimport * as fs from \"fs/promises\"\nimport * as path from \"path\"\nimport pathSorter from \"path-sort\"\nimport { assertThat } from \"../helpers/fileAssert\"\nimport { app, copyTestAsset, createMacTargetTest, getFixtureDir, parseFileList } from \"../helpers/packTester\"\n\ntest.ifMac(\"invalid target\", ({ expect }) => expect(createMacTargetTest(expect, [\"ttt\" as any])).rejects.toThrow())\n\ntest.ifNotWindows(\"only zip\", ({ expect }) => createMacTargetTest(expect, [\"zip\"], undefined, false /* no need to test sign */))\n\ntest.ifNotWindows(\"tar.gz\", ({ expect }) => createMacTargetTest(expect, [\"tar.gz\"]))\n\n// test.ifNotWindows(\"tar.xz\", createTargetTest([\"tar.xz\"], [\"Test App ßW-1.1.0-mac.tar.xz\"]))\n\nconst it = process.env.CSC_KEY_PASSWORD == null ? test.skip : test.ifMac\n\nit(\"pkg\", ({ expect }) => createMacTargetTest(expect, [\"pkg\"]))\n\ntest.ifMac(\"empty installLocation\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"pkg\", Arch.x64),\n      config: {\n        pkg: {\n          installLocation: \"\",\n        },\n      },\n    },\n    {\n      signed: false,\n      projectDirCreated: projectDir => {\n        return Promise.all([copyTestAsset(\"license.txt\", path.join(projectDir, \"build\", \"license.txt\"))])\n      },\n    }\n  )\n)\n\ntest.ifMac(\"extraDistFiles\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"zip\", Arch.x64),\n      config: {\n        mac: {\n          extraDistFiles: \"extra.txt\",\n        },\n      },\n    },\n    {\n      signed: false,\n      projectDirCreated: projectDir => {\n        return Promise.all([outputFile(path.join(projectDir, \"extra.txt\"), \"test\")])\n      },\n    }\n  )\n)\n\ntest.ifMac(\"pkg extended configuration\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"pkg\", Arch.x64),\n      config: {\n        pkg: {\n          isRelocatable: false,\n          isVersionChecked: false,\n          hasStrictIdentifier: false,\n          overwriteAction: \"update\",\n        },\n      },\n    },\n    {\n      signed: false,\n      packed: async context => {\n        const pkgPath = path.join(context.outDir, \"Test App ßW-1.1.0.pkg\")\n        const unpackedDir = path.join(context.outDir, \"pkg-unpacked\")\n        await exec(\"pkgutil\", [\"--expand\", pkgPath, unpackedDir])\n\n        const packageInfoFile = path.join(unpackedDir, \"org.electron-builder.testApp.pkg\", \"PackageInfo\")\n        const info = parseXml(await fs.readFile(packageInfoFile, \"utf8\"))\n\n        const relocateElement = info.elementOrNull(\"relocate\")\n        if (relocateElement != null) {\n          expect(relocateElement.elements).toBeNull()\n        }\n\n        const upgradeBundleElement = info.elementOrNull(\"upgrade-bundle\")\n        if (upgradeBundleElement != null) {\n          expect(upgradeBundleElement.elements).toBeNull()\n        }\n\n        const updateBundleElement = info.elementOrNull(\"update-bundle\")\n        if (updateBundleElement != null) {\n          expect(updateBundleElement.elements).toHaveLength(1)\n        }\n\n        const strictIdentifierElement = info.elementOrNull(\"strict-identifier\")\n        if (strictIdentifierElement != null) {\n          expect(strictIdentifierElement.elements).toBeNull()\n        }\n      },\n    }\n  )\n)\n\ntest.ifMac(\"pkg scripts\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"pkg\", Arch.x64),\n    },\n    {\n      signed: false,\n      projectDirCreated: async projectDir => {\n        await fs.symlink(path.join(getFixtureDir(), \"pkg-scripts\"), path.join(projectDir, \"build\", \"pkg-scripts\"))\n      },\n      packed: async context => {\n        const pkgPath = path.join(context.outDir, \"Test App ßW-1.1.0.pkg\")\n        console.log(\"CALL\")\n        const fileList = pathSorter(parseFileList(await exec(\"pkgutil\", [\"--payload-files\", pkgPath]), false))\n        expect(fileList).toMatchSnapshot()\n\n        const unpackedDir = path.join(context.outDir, \"pkg-unpacked\")\n        await exec(\"pkgutil\", [\"--expand\", pkgPath, unpackedDir])\n\n        const info = parseXml(await fs.readFile(path.join(unpackedDir, \"Distribution\"), \"utf8\"))\n        for (const element of info.getElements(\"pkg-ref\")) {\n          element.removeAttribute(\"installKBytes\")\n          element.removeAttribute(\"updateKBytes\")\n          const bundleVersion = element.elementOrNull(\"bundle-version\")\n          if (bundleVersion != null) {\n            bundleVersion.element(\"bundle\").removeAttribute(\"CFBundleVersion\")\n          }\n        }\n\n        // delete info.product.version\n        info.element(\"product\").removeAttribute(\"version\")\n\n        expect(info).toMatchSnapshot()\n\n        const scriptDir = path.join(unpackedDir, \"org.electron-builder.testApp.pkg\", \"Scripts\")\n        await assertThat(expect, path.join(scriptDir, \"postinstall\")).isFile()\n        await assertThat(expect, path.join(scriptDir, \"preinstall\")).isFile()\n      },\n    }\n  )\n)\n\ntest.ifMac(\"pkg hostArchitectures for arm64\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"pkg\", Arch.arm64),\n    },\n    {\n      signed: false,\n      packed: async context => {\n        const pkgPath = path.join(context.outDir, \"Test App ßW-1.1.0-arm64.pkg\")\n        const unpackedDir = path.join(context.outDir, \"pkg-unpacked\")\n        await exec(\"pkgutil\", [\"--expand\", pkgPath, unpackedDir])\n\n        const distributionXml = await fs.readFile(path.join(unpackedDir, \"Distribution\"), \"utf8\")\n        expect(distributionXml).toContain('hostArchitectures=\"arm64\"')\n      },\n    }\n  )\n)\n\ntest.ifMac(\"pkg hostArchitectures for x64\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"pkg\", Arch.x64),\n    },\n    {\n      signed: false,\n      packed: async context => {\n        const pkgPath = path.join(context.outDir, \"Test App ßW-1.1.0.pkg\")\n        const unpackedDir = path.join(context.outDir, \"pkg-unpacked\")\n        await exec(\"pkgutil\", [\"--expand\", pkgPath, unpackedDir])\n\n        const distributionXml = await fs.readFile(path.join(unpackedDir, \"Distribution\"), \"utf8\")\n        expect(distributionXml).toContain('hostArchitectures=\"x86_64\"')\n      },\n    }\n  )\n)\n\ntest.ifMac(\"pkg minimumSystemVersion adds volume-check\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"pkg\", Arch.arm64),\n      config: {\n        mac: {\n          minimumSystemVersion: \"12.0\",\n        },\n      },\n    },\n    {\n      signed: false,\n      packed: async context => {\n        const pkgPath = path.join(context.outDir, \"Test App ßW-1.1.0-arm64.pkg\")\n        const unpackedDir = path.join(context.outDir, \"pkg-unpacked\")\n        await exec(\"pkgutil\", [\"--expand\", pkgPath, unpackedDir])\n\n        const distributionXml = await fs.readFile(path.join(unpackedDir, \"Distribution\"), \"utf8\")\n        expect(distributionXml).toContain(\"<volume-check>\")\n        expect(distributionXml).toContain('<os-version min=\"12.0\"')\n      },\n    }\n  )\n)\n\ntest.ifMac(\"pkg extra packages\", async ({ expect }) => {\n  const extraPackages = path.join(\"build\", \"extra-packages\")\n  return app(\n    expect,\n    {\n      targets: Platform.MAC.createTarget(\"pkg\", Arch.x64),\n      config: {\n        pkg: {\n          extraPkgsDir: extraPackages,\n        },\n      },\n    },\n    {\n      signed: false,\n      projectDirCreated: async projectDir => {\n        const extraPackagesDir = path.join(projectDir, extraPackages)\n        await fs.mkdir(extraPackagesDir)\n        await fs.writeFile(path.join(extraPackagesDir, \"noop.pkg\"), \"data\")\n      },\n    }\n  )\n})\n"]}