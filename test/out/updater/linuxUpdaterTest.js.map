{"version":3,"file":"linuxUpdaterTest.js","sourceRoot":"","sources":["../../src/updater/linuxUpdaterTest.ts"],"names":[],"mappings":";;AACA,uDAAoF;AACpF,sDAAkD;AAClD,gEAAuH;AAEvH,iDAAwC;AAIxC,MAAM,OAAO,GAAG,KAAK,EAAE,MAAoB,EAAE,YAAiB,EAAE,iBAAsC,EAAE,EAAE;IACxG,MAAM,cAAc,GAAG,MAAM,IAAA,sCAAoB,EAAC,OAAO,CAAC,CAAA;IAC1D,MAAM,OAAO,GAAG,IAAI,YAAY,CAAC,IAAI,EAAE,cAAc,CAAC,CAAA;IACtD,IAAA,iCAAe,EAAC,OAAO,EAAE,EAAE,QAAQ,EAAE,OAAO,EAAE,CAAC,CAAA;IAE/C,OAAO,CAAC,gBAAgB,GAAG,MAAM,IAAA,mCAAiB,EAAgB;QAChE,QAAQ,EAAE,QAAQ;QAClB,KAAK,EAAE,UAAU;QACjB,IAAI,EAAE,uBAAuB;KAC9B,CAAC,CAAA;IAEF,MAAM,iBAAiB,GAAG,MAAM,IAAA,kCAAgB,EAAC,MAAM,EAAE,OAAO,CAAC,CAAA;IAEjE,MAAM,KAAK,GAAG,MAAM,CAAA,iBAAiB,aAAjB,iBAAiB,uBAAjB,iBAAiB,CAAE,eAAe,CAAA,CAAA;IACtD,MAAM,CAAC,KAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAA;IAChC,MAAM,SAAS,GAAG,KAAM,CAAC,CAAC,CAAC,CAAA;IAC3B,MAAM,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,iBAAiB,EAAE,CAAC,CAAC,CAAC,UAAU,EAAE,CAAA;IAChE,MAAM,IAAA,uBAAU,EAAC,MAAM,EAAE,SAAS,CAAC,CAAC,MAAM,EAAE,CAAA;IAE5C,MAAM,SAAS,GAAG,OAAO,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAA;IAC9C,MAAM,CAAC,SAAS,CAAC,CAAC,UAAU,EAAE,CAAA;AAChC,CAAC,CAAA;AAED,MAAM,oBAAoB,GAAG,CAAC,MAAc,EAAE,EAAE;IAC9C,OAAO,IAAA,wBAAQ,EAAC,iCAAiC,CAAC,CAAC,QAAQ,EAAE,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAA;AAChF,CAAC,CAAA;AAED,MAAM,iBAAiB,GAMnB;IACF,MAAM,EAAE;QACN,GAAG,EAAE,CAAC,QAAQ,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC;QACpC,OAAO,EAAE,6BAAU;QACnB,SAAS,EAAE,KAAK;KACjB;IACD,MAAM,EAAE;QACN,GAAG,EAAE,CAAC,KAAK,EAAE,MAAM,CAAC;QACpB,OAAO,EAAE,6BAAU;QACnB,SAAS,EAAE,KAAK;KACjB;IACD,IAAI,EAAE;QACJ,GAAG,EAAE,CAAC,QAAQ,CAAC;QACf,OAAO,EAAE,gCAAa;QACtB,SAAS,EAAE,QAAQ;KACpB;CACF,CAAA;AAED,KAAK,MAAM,MAAM,IAAI,iBAAiB,EAAE,CAAC;IACvC,MAAM,EAAE,GAAG,EAAE,OAAO,EAAE,OAAO,EAAE,SAAS,EAAE,GAAG,iBAAiB,CAAC,MAAwC,CAAC,CAAA;IACxG,KAAK,MAAM,EAAE,IAAI,GAAG,EAAE,CAAC;QACrB,IAAI,CAAC,KAAK,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,MAAM,0BAA0B,EAAE,GAAG,EAAE,KAAK,EAAE,EAAE,MAAM,EAAE,EAAE,EAAE;YAC3G,OAAO,CAAC,GAAG,CAAC,sCAAsC,GAAG,EAAE,CAAA;YACvD,MAAM,OAAO,CAAC,MAAM,EAAE,OAAO,EAAE,SAAS,CAAC,CAAA;QAC3C,CAAC,CAAC,CAAA;IACJ,CAAC;AACH,CAAC;AAED,iEAAiE;AACjE,uDAAuD;AACvD,KAAK","sourcesContent":["import { GithubOptions } from \"builder-util-runtime\"\nimport { AppUpdater, DebUpdater, PacmanUpdater, RpmUpdater } from \"electron-updater\"\nimport { assertThat } from \"../helpers/fileAssert\"\nimport { createTestAppAdapter, tuneTestUpdater, validateDownload, writeUpdateConfig } from \"../helpers/updaterTestUtil\"\nimport { ExpectStatic } from \"vitest\"\nimport { execSync } from \"child_process\"\n\ntype UpdateFileExtension = \"deb\" | \"rpm\" | \"AppImage\" | \"pacman\"\n\nconst runTest = async (expect: ExpectStatic, updaterClass: any, expectedExtension: UpdateFileExtension) => {\n  const testAppAdapter = await createTestAppAdapter(\"1.0.1\")\n  const updater = new updaterClass(null, testAppAdapter)\n  tuneTestUpdater(updater, { platform: \"linux\" })\n\n  updater.updateConfigPath = await writeUpdateConfig<GithubOptions>({\n    provider: \"github\",\n    owner: \"mmaietta\",\n    repo: \"electron-builder-test\",\n  })\n\n  const updateCheckResult = await validateDownload(expect, updater)\n\n  const files = await updateCheckResult?.downloadPromise\n  expect(files!.length).toEqual(1)\n  const installer = files![0]\n  expect(installer.endsWith(`.${expectedExtension}`)).toBeTruthy()\n  await assertThat(expect, installer).isFile()\n\n  const didUpdate = updater.install(true, false)\n  expect(didUpdate).toBeTruthy()\n}\n\nconst determineEnvironment = (target: string) => {\n  return execSync(`cat /etc/*release | grep \"^ID=\"`).toString().includes(target)\n}\n\nconst packageManagerMap: {\n  [key: string]: {\n    pms: string[]\n    updater: typeof AppUpdater\n    extension: UpdateFileExtension\n  }\n} = {\n  fedora: {\n    pms: [\"zypper\", \"dnf\", \"yum\", \"rpm\"],\n    updater: RpmUpdater,\n    extension: \"rpm\",\n  },\n  debian: {\n    pms: [\"apt\", \"dpkg\"],\n    updater: DebUpdater,\n    extension: \"deb\",\n  },\n  arch: {\n    pms: [\"pacman\"],\n    updater: PacmanUpdater,\n    extension: \"pacman\",\n  },\n}\n\nfor (const distro in packageManagerMap) {\n  const { pms, updater: Updater, extension } = packageManagerMap[distro as keyof typeof packageManagerMap]\n  for (const pm of pms) {\n    test.ifEnv(determineEnvironment(distro))(`test ${distro} download and install (${pm})`, async ({ expect }) => {\n      process.env.ELECTRON_BUILDER_LINUX_PACKAGE_MANAGER = pm\n      await runTest(expect, Updater, extension)\n    })\n  }\n}\n\n// test.ifLinux(\"test AppImage download\", async ({ expect }) => {\n//   await runTest(expect, AppImageUpdater, \"AppImage\")\n// })\n"]}