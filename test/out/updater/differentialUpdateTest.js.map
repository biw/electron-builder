{"version":3,"file":"differentialUpdateTest.js","sourceRoot":"","sources":["../../src/updater/differentialUpdateTest.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, Configuration, Platform } from \"app-builder-lib\"\nimport { getBinFromUrl } from \"app-builder-lib/out/binDownload\"\nimport { doSpawn, getArchSuffix } from \"builder-util\"\nimport { GenericServerOptions, Nullish, S3Options } from \"builder-util-runtime\"\nimport { AppImageUpdater, BaseUpdater, MacUpdater, NsisUpdater } from \"electron-updater\"\nimport { EventEmitter } from \"events\"\nimport { move } from \"fs-extra\"\nimport * as path from \"path\"\nimport { TmpDir } from \"temp-file\"\nimport { TestAppAdapter } from \"../helpers/TestAppAdapter\"\nimport { EXTENDED_TIMEOUT, PackedContext, assertPack, removeUnstableProperties } from \"../helpers/packTester\"\nimport { NEW_VERSION_NUMBER, OLD_VERSION_NUMBER, testAppCacheDirName, tuneTestUpdater, writeUpdateConfig } from \"../helpers/updaterTestUtil\"\nimport { mockForNodeRequire } from \"vitest-mock-commonjs\"\nimport { ExpectStatic } from \"vitest\"\n\nasync function doBuild(\n  expect: ExpectStatic,\n  outDirs: Array<string>,\n  targets: Map<Platform, Map<Arch, Array<string>>>,\n  tmpDir: TmpDir,\n  isWindows: boolean,\n  extraConfig?: Configuration | null\n) {\n  async function buildApp(\n    version: string,\n    targets: Map<Platform, Map<Arch, Array<string>>>,\n    extraConfig: Configuration | Nullish,\n    packed: (context: PackedContext) => Promise<any>\n  ) {\n    await assertPack(\n      expect,\n      \"test-app-one\",\n      {\n        targets,\n        config: {\n          extraMetadata: {\n            version,\n          },\n          ...extraConfig,\n          compression: \"normal\",\n          publish: {\n            provider: \"s3\",\n            bucket: \"develar\",\n            path: \"test\",\n          },\n        },\n      },\n      {\n        signedWin: isWindows,\n        packed,\n      }\n    )\n  }\n\n  const build = (version: string) =>\n    buildApp(version, targets, extraConfig, async context => {\n      // move dist temporarily out of project dir so each downloader can reference it\n      const newDir = await tmpDir.getTempDir({ prefix: version })\n      await move(context.outDir, newDir)\n      outDirs.push(newDir)\n    })\n  try {\n    await build(OLD_VERSION_NUMBER)\n    await build(NEW_VERSION_NUMBER)\n  } catch (e: any) {\n    await tmpDir.cleanup()\n    throw e\n  }\n}\n\ntest.ifWindows(\"web installer\", { retry: 2 }, async ({ expect }) => {\n  const outDirs: Array<string> = []\n  const tmpDir = new TmpDir(\"differential-updater-test\")\n  await doBuild(expect, outDirs, Platform.WINDOWS.createTarget([\"nsis-web\"], Arch.x64), tmpDir, true)\n\n  const oldDir = outDirs[0]\n  await move(path.join(oldDir, \"nsis-web\", `TestApp-${OLD_VERSION_NUMBER}-x64.nsis.7z`), path.join(getTestUpdaterCacheDir(oldDir), testAppCacheDirName, \"package.7z\"))\n\n  await testBlockMap(expect, outDirs[0], path.join(outDirs[1], \"nsis-web\"), NsisUpdater, Platform.WINDOWS, Arch.x64)\n})\n\ntest.ifWindows(\"nsis\", async ({ expect }) => {\n  const outDirs: Array<string> = []\n  const tmpDir = new TmpDir(\"differential-updater-test\")\n  await doBuild(expect, outDirs, Platform.WINDOWS.createTarget([\"nsis\"], Arch.x64), tmpDir, true)\n\n  const oldDir = outDirs[0]\n  // move to new dir so that localhost server can read both blockmaps\n  await move(path.join(oldDir, `Test App ßW Setup ${OLD_VERSION_NUMBER}.exe`), path.join(getTestUpdaterCacheDir(oldDir), testAppCacheDirName, \"installer.exe\"))\n  await move(path.join(oldDir, `Test App ßW Setup ${OLD_VERSION_NUMBER}.exe.blockmap`), path.join(outDirs[1], \"Test App ßW Setup 1.0.0.exe.blockmap\"))\n\n  await testBlockMap(expect, outDirs[0], outDirs[1], NsisUpdater, Platform.WINDOWS, Arch.x64)\n})\n\nasync function testLinux(expect: ExpectStatic, arch: Arch) {\n  process.env.TEST_UPDATER_ARCH = Arch[arch]\n\n  const outDirs: Array<string> = []\n  const tmpDir = new TmpDir(\"differential-updater-test\")\n  try {\n    await doBuild(expect, outDirs, Platform.LINUX.createTarget([\"appimage\"], arch), tmpDir, false)\n\n    process.env.APPIMAGE = path.join(outDirs[0], `Test App ßW-${OLD_VERSION_NUMBER}${arch === Arch.ia32 ? \"-i386\" : \"\"}.AppImage`)\n    await testBlockMap(expect, outDirs[0], outDirs[1], AppImageUpdater, Platform.LINUX, arch)\n  } finally {\n    await tmpDir.cleanup()\n  }\n}\n\ntest.ifLinux(\"AppImage\", ({ expect }) => testLinux(expect, Arch.x64))\n\n// Skipped, electron no longer ships ia32 linux binaries\ntest.ifLinux.skip(\"AppImage ia32\", ({ expect }) => testLinux(expect, Arch.ia32))\n\nasync function testMac(expect: ExpectStatic, arch: Arch) {\n  process.env.TEST_UPDATER_ARCH = Arch[arch]\n\n  const outDirs: Array<string> = []\n  const tmpDir = new TmpDir(\"differential-updater-test\")\n  try {\n    await doBuild(expect, outDirs, Platform.MAC.createTarget([\"zip\"], arch), tmpDir, false, {\n      mac: {\n        electronUpdaterCompatibility: \">=2.17.0\",\n      },\n    })\n\n    // move to new dir so that localhost server can read both blockmaps\n    const oldDir = outDirs[0]\n    const blockmap = `Test App ßW-${OLD_VERSION_NUMBER}${getArchSuffix(arch)}-mac.zip.blockmap`\n    await move(path.join(oldDir, blockmap), path.join(outDirs[1], blockmap))\n    await move(path.join(oldDir, `Test App ßW-${OLD_VERSION_NUMBER}${getArchSuffix(arch)}-mac.zip`), path.join(getTestUpdaterCacheDir(oldDir), testAppCacheDirName, \"update.zip\"))\n\n    await testBlockMap(expect, outDirs[0], outDirs[1], MacUpdater, Platform.MAC, arch, \"Test App ßW\")\n  } finally {\n    await tmpDir.cleanup()\n  }\n}\n\ntest.ifMac(\"Mac Intel\", ({ expect }) => testMac(expect, Arch.x64))\ntest.ifMac(\"Mac universal\", { timeout: EXTENDED_TIMEOUT }, ({ expect }) => testMac(expect, Arch.universal))\n\n// only run on arm64 macs, otherwise of course no files can be found to be updated to (due to arch mismatch)\ntest.ifMac.ifEnv(process.arch === \"arm64\")(\"Mac arm64\", ({ expect }) => testMac(expect, Arch.arm64))\n\nexport async function checkResult(expect: ExpectStatic, updater: BaseUpdater) {\n  // disable automatic install otherwise mac updater will permanently wait on mocked electron's native updater to receive update (mocked server can't install)\n  updater.autoInstallOnAppQuit = false\n\n  const updateCheckResult = await updater.checkForUpdates()\n  const downloadPromise = updateCheckResult?.downloadPromise\n  // noinspection JSIgnoredPromiseFromCall\n  expect(downloadPromise).not.toBeNull()\n  const files = await downloadPromise\n  const fileInfo: any = updateCheckResult?.updateInfo.files[0]\n\n  // delete url because port is random\n  expect(fileInfo.url).toBeDefined()\n  delete fileInfo.url\n  expect(removeUnstableProperties(updateCheckResult?.updateInfo)).toMatchSnapshot()\n  expect(files!.map(it => path.basename(it))).toMatchSnapshot()\n}\n\nclass TestNativeUpdater extends EventEmitter {\n  checkForUpdates() {\n    console.log(\"TestNativeUpdater.checkForUpdates\")\n    // MacUpdater expects this to emit corresponding update-downloaded event\n    this.emit(\"update-downloaded\")\n  }\n  setFeedURL(updateConfig: any) {\n    console.log(\"TestNativeUpdater.setFeedURL \" + updateConfig.url)\n  }\n  getFeedURL() {\n    console.log(\"TestNativeUpdater.getFeedURL\")\n  }\n  quitAndInstall() {\n    console.log(\"TestNativeUpdater.quitAndInstall\")\n  }\n}\n\nfunction getTestUpdaterCacheDir(oldDir: string) {\n  return path.join(oldDir, \"updater-cache\")\n}\n\nasync function testBlockMap(expect: ExpectStatic, oldDir: string, newDir: string, updaterClass: any, platform: Platform, arch: Arch, productFilename?: string) {\n  const appUpdateConfigPath = path.join(\n    `${platform.buildConfigurationKey}${getArchSuffix(arch)}${platform === Platform.MAC ? \"\" : \"-unpacked\"}`,\n    platform === Platform.MAC ? `${productFilename}.app` : \"\"\n  )\n  const port = 8000 + (updaterClass.name.charCodeAt(0) as number) + Math.floor(Math.random() * 10000)\n\n  const serverBin = await getBinFromUrl(\"ran-0.1.3\", \"ran-0.1.3.7z\", \"imfA3LtT6umMM0BuQ29MgO3CJ9uleN5zRBi3sXzcTbMOeYZ6SQeN7eKr3kXZikKnVOIwbH+DDO43wkiR/qTdkg==\")\n  const httpServerProcess = doSpawn(path.join(serverBin, process.platform, \"ran\"), [`-root=${newDir}`, `-port=${port}`, \"-gzip=false\", \"-listdir=true\"])\n\n  // Mac uses electron's native autoUpdater to serve updates to, we mock here since electron API isn't available within jest runtime\n  const mockNativeUpdater = new TestNativeUpdater()\n  mockForNodeRequire(\"electron\", {\n    autoUpdater: mockNativeUpdater,\n  })\n\n  return await new Promise<void>((resolve, reject) => {\n    httpServerProcess.on(\"error\", reject)\n\n    const updater = new updaterClass(null, new TestAppAdapter(OLD_VERSION_NUMBER, getTestUpdaterCacheDir(oldDir)))\n    updater._appUpdateConfigPath = path.join(\n      oldDir,\n      updaterClass === MacUpdater ? `${appUpdateConfigPath}/Contents/Resources` : `${appUpdateConfigPath}/resources`,\n      \"app-update.yml\"\n    )\n    const doTest = async () => {\n      tuneTestUpdater(updater, {\n        platform: platform.nodeName as any,\n        isUseDifferentialDownload: true,\n      })\n\n      const currentUpdaterCacheDirName = (await updater.configOnDisk.value).updaterCacheDirName\n      if (currentUpdaterCacheDirName == null) {\n        throw new Error(`currentUpdaterCacheDirName must be not null, appUpdateConfigPath: ${updater._appUpdateConfigPath}`)\n      }\n\n      updater.updateConfigPath = await writeUpdateConfig<GenericServerOptions | S3Options>({\n        provider: \"generic\",\n        updaterCacheDirName: currentUpdaterCacheDirName,\n        url: `http://127.0.0.1:${port}`,\n      })\n\n      await checkResult(expect, updater)\n    }\n\n    doTest().then(resolve).catch(reject)\n  }).then(\n    v => {\n      httpServerProcess.kill()\n      return v\n    },\n    e => {\n      httpServerProcess.kill()\n      throw e\n    }\n  )\n}\n"]}