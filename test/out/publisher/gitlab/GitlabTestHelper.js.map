{"version":3,"file":"GitlabTestHelper.js","sourceRoot":"","sources":["../../../src/publisher/gitlab/GitlabTestHelper.ts"],"names":[],"mappings":"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","sourcesContent":["import { httpExecutor, log } from \"builder-util\"\nimport { GitlabReleaseInfo, HttpError } from \"builder-util-runtime\"\n\n/**\n * Helper class for GitLab test operations\n *\n * Provides methods for interacting with GitLab API during testing,\n * including release management and cleanup operations.\n */\nexport class GitlabTestHelper {\n  private readonly token: string\n  private readonly host: string\n  private readonly projectId: string\n\n  constructor({\n    // gitlab repo for this project is `https://gitlab.com/daihere1993/gitlab-electron-updater-test-2`\n    projectId = \"72170733\",\n    host = \"gitlab.com\",\n  }: {\n    projectId?: string\n    host?: string\n  } = {}) {\n    this.token = process.env.GITLAB_TOKEN || \"\"\n    this.host = host\n    this.projectId = String(projectId)\n  }\n\n  /**\n   * Make authenticated request to GitLab API\n   */\n  private async gitlabRequest<T>(path: string, data?: any, method: string = \"GET\"): Promise<T | null> {\n    const requestOptions = {\n      hostname: this.host,\n      path: `/api/v4${path}`,\n      method: method,\n      headers: {\n        \"Private-Token\": this.token,\n        accept: \"application/json\",\n      },\n    }\n\n    try {\n      const response = await httpExecutor.request(requestOptions, undefined, data)\n      return response ? JSON.parse(response) : null\n    } catch (e: unknown) {\n      if (e instanceof HttpError && e.statusCode === 404) {\n        return null\n      }\n      throw e\n    }\n  }\n\n  /**\n   * Get release information by tag name\n   */\n  async getRelease(releaseId: string): Promise<GitlabReleaseInfo | null> {\n    try {\n      return await this.gitlabRequest<GitlabReleaseInfo>(`/projects/${encodeURIComponent(this.projectId)}/releases/${releaseId}`)\n    } catch (e: unknown) {\n      if (e instanceof HttpError && e.statusCode === 404) {\n        return null\n      }\n      throw e\n    }\n  }\n\n  /**\n   * Delete GitLab release by tag name\n   */\n  async deleteRelease(releaseId: string): Promise<void> {\n    const release = await this.getRelease(releaseId)\n    if (release == null) {\n      log.warn({ releaseId, reason: \"doesn't exist\" }, \"cannot delete release\")\n      return\n    }\n\n    try {\n      await this.gitlabRequest(`/projects/${encodeURIComponent(this.projectId)}/releases/${releaseId}`, null, \"DELETE\")\n    } catch (e: unknown) {\n      if (e instanceof HttpError && e.statusCode === 404) {\n        log.warn({ releaseId, reason: \"doesn't exist\" }, \"cannot delete release\")\n        return\n      }\n      throw e\n    }\n  }\n\n  /**\n   * Delete GitLab release and corresponding git tag\n   */\n  async deleteReleaseAndTag(releaseId: string): Promise<void> {\n    const release = await this.getRelease(releaseId)\n    if (release == null) {\n      log.warn({ releaseId, reason: \"doesn't exist\" }, \"cannot delete release\")\n      return\n    }\n\n    try {\n      // First delete the release\n      await this.deleteRelease(releaseId)\n      log.debug({ releaseId }, \"Deleted GitLab release\")\n    } catch (e: unknown) {\n      log.warn({ releaseId, error: (e as Error).message }, \"Failed to delete GitLab release\")\n    }\n\n    try {\n      // Then delete the git tag\n      await this.gitlabRequest(`/projects/${encodeURIComponent(this.projectId)}/repository/tags/${encodeURIComponent(releaseId)}`, null, \"DELETE\")\n      log.debug({ releaseId }, \"Deleted GitLab tag\")\n    } catch (e: unknown) {\n      if (e instanceof HttpError && e.statusCode === 404) {\n        log.warn({ releaseId, reason: \"doesn't exist\" }, \"cannot delete git tag\")\n        return\n      }\n      log.warn({ releaseId, error: (e as Error).message }, \"Failed to delete GitLab tag\")\n    }\n  }\n\n  /**\n   * Delete uploaded assets (generic packages only)\n   *\n   * Note: Project uploads are automatically deleted by GitLab when the release is deleted.\n   */\n  async deleteUploadedAssets(releaseId: string): Promise<void> {\n    try {\n      // Only need to delete generic packages - project uploads are auto-deleted with releases\n      await this.deleteGenericPackages(releaseId)\n    } catch (e: unknown) {\n      log.warn({ releaseId, error: (e as Error).message }, \"Failed to cleanup uploaded assets\")\n    }\n  }\n\n  /**\n   * Delete generic packages matching version from Package Registry\n   */\n  async deleteGenericPackages(version: string): Promise<void> {\n    try {\n      // Get all packages for the \"releases\" package name\n      const packages = await this.gitlabRequest<any[]>(`/projects/${encodeURIComponent(this.projectId)}/packages?package_name=releases`)\n\n      if (!packages || packages.length === 0) {\n        return\n      }\n\n      // Find packages that match our version\n      const matchingPackages = packages.filter(pkg => pkg.name === \"releases\" && pkg.version === version)\n\n      // Delete matching packages\n      const deletePromises = matchingPackages.map(async (pkg: any) => {\n        try {\n          await this.gitlabRequest(`/projects/${encodeURIComponent(this.projectId)}/packages/${pkg.id}`, null, \"DELETE\")\n          log.debug({ packageId: pkg.id, version: pkg.version }, \"Deleted GitLab generic package\")\n        } catch (e: unknown) {\n          log.warn({ packageId: pkg.id, version: pkg.version, error: (e as Error).message }, \"Failed to delete GitLab generic package\")\n        }\n      })\n\n      await Promise.allSettled(deletePromises)\n    } catch (e: unknown) {\n      log.warn({ version, error: (e as Error).message }, \"Failed to cleanup generic packages\")\n    }\n  }\n\n  /**\n   * Get all releases from GitLab project\n   */\n  async getAllReleases(): Promise<GitlabReleaseInfo[]> {\n    try {\n      const releases = await this.gitlabRequest<GitlabReleaseInfo[]>(`/projects/${encodeURIComponent(this.projectId)}/releases`)\n      return releases || []\n    } catch (e: unknown) {\n      throw new Error(`Failed to get all releases: ${(e as Error).message}`)\n    }\n  }\n}\n"]}