{"version":3,"file":"winCodeSignTest.js","sourceRoot":"","sources":["../../src/windows/winCodeSignTest.ts"],"names":[],"mappings":"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","sourcesContent":["import { parseDn } from \"builder-util-runtime\"\nimport { DIR_TARGET, Platform } from \"electron-builder\"\nimport { outputFile } from \"fs-extra\"\nimport { load } from \"js-yaml\"\nimport * as path from \"path\"\nimport { CheckingWinPackager } from \"../helpers/CheckingPackager\"\nimport { app, appThrows } from \"../helpers/packTester\"\nimport { ExpectStatic } from \"vitest\"\n\ntest(\"parseDn\", ({ expect }) => {\n  expect(parseDn(\"CN=7digital Limited, O=7digital Limited, L=London, C=GB\")).toMatchSnapshot()\n\n  expect(load(\"publisherName:\\n  - 7digital Limited\")).toMatchObject({ publisherName: [\"7digital Limited\"] })\n})\n\nconst windowsDirTarget = Platform.WINDOWS.createTarget([\"dir\"])\n\ntest(\"sign nested asar unpacked executables\", ({ expect }) =>\n  appThrows(\n    expect,\n    {\n      targets: Platform.WINDOWS.createTarget(DIR_TARGET),\n      config: {\n        publish: \"never\",\n        asarUnpack: [\"assets\"],\n      },\n    },\n    {\n      signedWin: true,\n      projectDirCreated: async projectDir => {\n        await outputFile(path.join(projectDir, \"assets\", \"nested\", \"nested\", \"file.exe\"), \"invalid PE file\")\n      },\n    },\n    error => {\n      if (process.platform === \"win32\") {\n        expect(error.message).toContain(\"This file format cannot be signed because it is not recognized.\")\n      } else {\n        expect(error.message).toContain(\"Unrecognized file type\")\n      }\n    }\n  ))\n\nfunction testCustomSign(expect: ExpectStatic, sign: any) {\n  return app(expect, {\n    targets: Platform.WINDOWS.createTarget(DIR_TARGET),\n    platformPackagerFactory: (packager, platform) => new CheckingWinPackager(packager),\n    config: {\n      win: {\n        signtoolOptions: {\n          certificatePassword: \"pass\",\n          certificateFile: \"secretFile\",\n          sign,\n          signingHashAlgorithms: [\"sha256\"],\n        },\n        // to be sure that sign code will be executed\n        forceCodeSigning: true,\n      },\n    },\n  })\n}\n\ntest(\"certificateFile/password - sign as async/await\", ({ expect }) =>\n  testCustomSign(expect, async () => {\n    return Promise.resolve()\n  }))\ntest(\"certificateFile/password - sign as Promise\", ({ expect }) => testCustomSign(expect, () => Promise.resolve()))\ntest(\"certificateFile/password - sign as function\", async ({ expect }) => testCustomSign(expect, (await import(\"../helpers/customWindowsSign\")).default))\ntest(\"certificateFile/password - sign as path\", ({ expect }) => testCustomSign(expect, path.join(__dirname, \"../helpers/customWindowsSign.mjs\")))\n\ntest(\"custom sign if no code sign info\", ({ expect }) => {\n  let called = false\n  return app(\n    expect,\n    {\n      targets: Platform.WINDOWS.createTarget(DIR_TARGET),\n      platformPackagerFactory: (packager, platform) => new CheckingWinPackager(packager),\n      config: {\n        win: {\n          // to be sure that sign code will be executed\n          forceCodeSigning: true,\n          signtoolOptions: {\n            sign: async () => {\n              called = true\n            },\n          },\n        },\n      },\n    },\n    {\n      packed: async () => {\n        expect(called).toBe(true)\n      },\n    }\n  )\n})\n\ntest(\"forceCodeSigning\", ({ expect }) =>\n  appThrows(expect, {\n    targets: windowsDirTarget,\n    config: {\n      forceCodeSigning: true,\n    },\n  }))\n\ntest(\"electronDist\", ({ expect }) =>\n  appThrows(\n    expect,\n    {\n      targets: windowsDirTarget,\n      config: {\n        electronDist: \"foo\",\n      },\n    },\n    {},\n    error => expect(error.message).toContain(\"Please provide a valid path to the Electron zip file, cache directory, or electron build directory.\")\n  ))\n\ntest(\"azure signing without credentials\", ({ expect }) =>\n  appThrows(\n    expect,\n    {\n      targets: windowsDirTarget,\n      config: {\n        forceCodeSigning: true,\n        win: {\n          azureSignOptions: {\n            publisherName: \"test\",\n            endpoint: \"https://weu.codesigning.azure.net/\",\n            certificateProfileName: \"profilenamehere\",\n            codeSigningAccountName: \"codesigningnamehere\",\n          },\n        },\n      },\n    },\n    {},\n    error => expect(error.message).toContain(\"Unable to find valid azure env field AZURE_TENANT_ID for signing.\")\n  ))\n\ntest.ifNotWindows(\"win code sign using pwsh\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.WINDOWS.createTarget(DIR_TARGET),\n    },\n    {\n      signedWin: true,\n    }\n  )\n)\n"]}