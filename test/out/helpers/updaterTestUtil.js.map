{"version":3,"file":"updaterTestUtil.js","sourceRoot":"","sources":["../../src/helpers/updaterTestUtil.ts"],"names":[],"mappings":";;;AAYA,oDAEC;AAED,8CAKC;AAGD,8CAIC;AAED,4CA4BC;AAaD,0CAOC;AAED,kCAQC;AAxFD,+CAAwE;AAExE,uDAAsE;AACtE,gEAAoF;AACpF,uCAAgD;AAChD,6BAA4B;AAC5B,6CAAyC;AACzC,qDAAiD;AAGjD,MAAM,MAAM,GAAG,IAAI,qBAAM,CAAC,mBAAmB,CAAC,CAAA;AAEvC,KAAK,UAAU,oBAAoB,CAAC,OAAO,GAAG,OAAO;IAC1D,OAAO,IAAI,+BAAc,CAAC,OAAO,EAAE,MAAM,MAAM,CAAC,UAAU,EAAE,CAAC,CAAA;AAC/D,CAAC;AAEM,KAAK,UAAU,iBAAiB,CAAC,OAAO,GAAG,OAAO;IACvD,MAAM,cAAc,GAAG,MAAM,oBAAoB,CAAC,OAAO,CAAC,CAAA;IAC1D,MAAM,MAAM,GAAG,IAAI,8BAAW,CAAC,IAAI,EAAE,cAAc,CAAC,CAAA;IACpD,eAAe,CAAC,MAAM,CAAC,CAAA;IACvB,OAAO,MAAM,CAAA;AACf,CAAC;AAED,uIAAuI;AAChI,KAAK,UAAU,iBAAiB,CAA8B,IAAO;IAC1E,MAAM,gBAAgB,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,MAAM,CAAC,UAAU,CAAC,EAAE,MAAM,EAAE,oBAAoB,EAAE,CAAC,EAAE,gBAAgB,CAAC,CAAA;IAC/G,MAAM,IAAA,qBAAU,EAAC,gBAAgB,EAAE,IAAA,8BAAe,EAAC,IAAI,CAAC,CAAC,CAAA;IACzD,OAAO,gBAAgB,CAAA;AACzB,CAAC;AAEM,KAAK,UAAU,gBAAgB,CAAC,MAAoB,EAAE,OAAmB,EAAE,qBAAqB,GAAG,IAAI;IAC5G,MAAM,YAAY,GAAG,WAAW,CAAC,OAAO,CAAC,CAAA;IAEzC,MAAM,iBAAiB,GAAG,MAAM,OAAO,CAAC,eAAe,EAAE,CAAA;IACzD,MAAM,MAAM,GAAG,CAAC,iBAAiB,aAAjB,iBAAiB,uBAAjB,iBAAiB,CAAE,UAAkB,CAAA,CAAC,MAAM,CAAA;IAC5D,IAAI,MAAM,IAAI,IAAI,EAAE,CAAC;QACnB,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;YAC3B,OAAO,KAAK,CAAC,cAAc,CAAA;QAC7B,CAAC;IACH,CAAC;IAED,MAAM,CAAC,iBAAiB,aAAjB,iBAAiB,uBAAjB,iBAAiB,CAAE,UAAU,CAAC,CAAC,eAAe,EAAE,CAAA;IACvD,IAAI,qBAAqB,EAAE,CAAC;QAC1B,wCAAwC;QACxC,MAAM,CAAC,iBAAiB,aAAjB,iBAAiB,uBAAjB,iBAAiB,CAAE,eAAe,CAAC,CAAC,WAAW,EAAE,CAAA;QACxD,MAAM,cAAc,GAAG,MAAM,CAAA,iBAAiB,aAAjB,iBAAiB,uBAAjB,iBAAiB,CAAE,eAAe,CAAA,CAAA;QAC/D,IAAI,OAAO,YAAY,6BAAU,EAAE,CAAC;YAClC,MAAM,CAAC,cAAc,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAA;QACpC,CAAC;aAAM,CAAC;YACN,MAAM,IAAA,uBAAU,EAAC,MAAM,EAAE,IAAI,CAAC,IAAI,CAAC,cAAe,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,CAAA;QAClE,CAAC;IACH,CAAC;SAAM,CAAC;QACN,wCAAwC;QACxC,MAAM,CAAC,iBAAiB,aAAjB,iBAAiB,uBAAjB,iBAAiB,CAAE,eAAe,CAAC,CAAC,aAAa,EAAE,CAAA;IAC5D,CAAC;IAED,MAAM,CAAC,YAAY,CAAC,CAAC,eAAe,EAAE,CAAA;IACtC,OAAO,iBAAiB,CAAA;AAC1B,CAAC;AAED,MAAa,oBAAqB,SAAQ,+BAAgB;IACxD,KAAK,CAAC,QAAQ,CAAC,GAAW,EAAE,WAAmB,EAAE,OAAwB;QACvE,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,GAAG,CAAC,CAAA;QACxB,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,GAAG,EAAE,OAAO,CAAC,CAAA;QACxD,MAAM,IAAA,oBAAS,EAAC,WAAW,EAAE,MAAM,CAAC,CAAA;QACpC,OAAO,MAAM,CAAC,QAAQ,EAAE,CAAA;IAC1B,CAAC;CACF;AAPD,oDAOC;AAEY,QAAA,YAAY,GAAyB,IAAI,oBAAoB,EAAE,CAAA;AAE5E,SAAgB,eAAe,CAAC,OAAmB,EAAE,OAAgC;IACnF,CAAC;IAAC,OAAe,CAAC,YAAY,GAAG,oBAAY,CAC5C;IAAC,OAAe,CAAC,gBAAgB,GAAG;QACnC,QAAQ,EAAE,OAAO;QACjB,GAAG,OAAO;KACX,CAAA;IACD,OAAO,CAAC,MAAM,GAAG,IAAI,uBAAU,EAAE,CAAA;AACnC,CAAC;AAED,SAAgB,WAAW,CAAC,OAAmB;IAC7C,MAAM,YAAY,GAAkB,EAAE,CAAA;IACtC,KAAK,MAAM,SAAS,IAAI,CAAC,qBAAqB,EAAE,kBAAkB,EAAE,mBAAmB,EAAE,OAAO,CAAU,EAAE,CAAC;QAC3G,OAAO,CAAC,WAAW,CAAC,SAAS,EAAE,GAAG,EAAE;YAClC,YAAY,CAAC,IAAI,CAAC,SAAS,CAAC,CAAA;QAC9B,CAAC,CAAC,CAAA;IACJ,CAAC;IACD,OAAO,YAAY,CAAA;AACrB,CAAC;AACY,QAAA,kBAAkB,GAAG,OAAO,CAAA;AAC5B,QAAA,kBAAkB,GAAG,OAAO,CAAA;AAE5B,QAAA,mBAAmB,GAAG,iBAAiB,CAAA","sourcesContent":["import { NodeHttpExecutor, serializeToYaml, TmpDir } from \"builder-util\"\nimport { AllPublishOptions, DownloadOptions } from \"builder-util-runtime\"\nimport { AppUpdater, MacUpdater, NsisUpdater } from \"electron-updater\"\nimport { NoOpLogger, TestOnlyUpdaterOptions } from \"electron-updater/out/AppUpdater\"\nimport { outputFile, writeFile } from \"fs-extra\"\nimport * as path from \"path\"\nimport { assertThat } from \"./fileAssert\"\nimport { TestAppAdapter } from \"./TestAppAdapter\"\nimport { ExpectStatic } from \"vitest\"\n\nconst tmpDir = new TmpDir(\"updater-test-util\")\n\nexport async function createTestAppAdapter(version = \"0.0.1\") {\n  return new TestAppAdapter(version, await tmpDir.getTempDir())\n}\n\nexport async function createNsisUpdater(version = \"0.0.1\") {\n  const testAppAdapter = await createTestAppAdapter(version)\n  const result = new NsisUpdater(null, testAppAdapter)\n  tuneTestUpdater(result)\n  return result\n}\n\n// to reduce difference in test mode, setFeedURL is not used to set (NsisUpdater also read configOnDisk to load original publisherName)\nexport async function writeUpdateConfig<T extends AllPublishOptions>(data: T): Promise<string> {\n  const updateConfigPath = path.join(await tmpDir.getTempDir({ prefix: \"test-update-config\" }), \"app-update.yml\")\n  await outputFile(updateConfigPath, serializeToYaml(data))\n  return updateConfigPath\n}\n\nexport async function validateDownload(expect: ExpectStatic, updater: AppUpdater, expectDownloadPromise = true) {\n  const actualEvents = trackEvents(updater)\n\n  const updateCheckResult = await updater.checkForUpdates()\n  const assets = (updateCheckResult?.updateInfo as any).assets\n  if (assets != null) {\n    for (const asset of assets) {\n      delete asset.download_count\n    }\n  }\n\n  expect(updateCheckResult?.updateInfo).toMatchSnapshot()\n  if (expectDownloadPromise) {\n    // noinspection JSIgnoredPromiseFromCall\n    expect(updateCheckResult?.downloadPromise).toBeDefined()\n    const downloadResult = await updateCheckResult?.downloadPromise\n    if (updater instanceof MacUpdater) {\n      expect(downloadResult).toEqual([])\n    } else {\n      await assertThat(expect, path.join(downloadResult![0])).isFile()\n    }\n  } else {\n    // noinspection JSIgnoredPromiseFromCall\n    expect(updateCheckResult?.downloadPromise).toBeUndefined()\n  }\n\n  expect(actualEvents).toMatchSnapshot()\n  return updateCheckResult\n}\n\nexport class TestNodeHttpExecutor extends NodeHttpExecutor {\n  async download(url: string, destination: string, options: DownloadOptions): Promise<string> {\n    const obj = new URL(url)\n    const buffer = await this.downloadToBuffer(obj, options)\n    await writeFile(destination, buffer)\n    return buffer.toString()\n  }\n}\n\nexport const httpExecutor: TestNodeHttpExecutor = new TestNodeHttpExecutor()\n\nexport function tuneTestUpdater(updater: AppUpdater, options?: TestOnlyUpdaterOptions) {\n  ;(updater as any).httpExecutor = httpExecutor\n  ;(updater as any)._testOnlyOptions = {\n    platform: \"win32\",\n    ...options,\n  }\n  updater.logger = new NoOpLogger()\n}\n\nexport function trackEvents(updater: AppUpdater) {\n  const actualEvents: Array<string> = []\n  for (const eventName of [\"checking-for-update\", \"update-available\", \"update-downloaded\", \"error\"] as const) {\n    updater.addListener(eventName, () => {\n      actualEvents.push(eventName)\n    })\n  }\n  return actualEvents\n}\nexport const OLD_VERSION_NUMBER = \"1.0.0\"\nexport const NEW_VERSION_NUMBER = \"1.0.1\"\n\nexport const testAppCacheDirName = \"testapp-updater\"\n"]}