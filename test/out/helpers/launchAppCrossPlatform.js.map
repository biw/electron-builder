{"version":3,"file":"launchAppCrossPlatform.js","sourceRoot":"","sources":["../../src/helpers/launchAppCrossPlatform.ts"],"names":[],"mappings":"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","sourcesContent":["import { isEmptyOrSpaces } from \"builder-util\"\nimport { ChildProcess, spawn } from \"child_process\"\nimport { chmodSync } from \"fs\"\nimport os from \"os\"\nimport path from \"path\"\n\ninterface LaunchResult {\n  version?: string\n  exitCode: number | null\n  stdout: string\n  stderr: string\n}\n\ninterface LaunchOptions {\n  appPath: string\n  timeoutMs?: number\n  env?: Record<string, string>\n  expectedVersion?: string\n  updateConfigPath: string\n  packageManagerToTest: string\n}\n\nexport async function launchAndWaitForQuit({\n  appPath,\n  timeoutMs = 20000,\n  env = {},\n  expectedVersion,\n  updateConfigPath,\n  packageManagerToTest,\n}: LaunchOptions): Promise<LaunchResult> {\n  let child: ChildProcess\n  const versionRegex = /APP_VERSION:\\s*([0-9]+\\.[0-9]+\\.[0-9]+)/\n\n  function spawnApp(command: string, args: string[] = [], detached = true, localEnv = env) {\n    return spawn(command, args, {\n      detached,\n      shell: false,\n      stdio: [\"ignore\", \"pipe\", \"pipe\"],\n      env: {\n        ...process.env,\n        AUTO_UPDATER_TEST: \"1\",\n        AUTO_UPDATER_TEST_CONFIG_PATH: updateConfigPath,\n        ELECTRON_BUILDER_LINUX_PACKAGE_MANAGER: packageManagerToTest,\n        ...localEnv,\n      },\n    })\n  }\n\n  const platform = os.platform()\n  switch (platform) {\n    case \"darwin\": {\n      const binary = path.join(appPath, \"Contents\", \"MacOS\", path.basename(appPath, \".app\"))\n      child = spawnApp(binary)\n      break\n    }\n\n    case \"win32\": {\n      child = spawnApp(appPath)\n      break\n    }\n\n    case \"linux\": {\n      const { display } = startXvfb()\n      await new Promise(resolve => setTimeout(resolve, 500)) // Give Xvfb time to init\n\n      if (appPath.endsWith(\".AppImage\")) {\n        chmodSync(appPath, 0o755)\n        const spawnEnv = {\n          ...env,\n          DISPLAY: display,\n          APPIMAGE_EXTRACT_AND_RUN: \"1\",\n        }\n\n        child = spawn(appPath, [\"--no-sandbox\"], {\n          detached: true,\n          shell: false,\n          stdio: [\"ignore\", \"pipe\", \"pipe\"],\n          env: {\n            ...process.env,\n            AUTO_UPDATER_TEST: \"1\",\n            AUTO_UPDATER_TEST_CONFIG_PATH: updateConfigPath,\n            ...spawnEnv,\n          },\n        })\n      } else {\n        child = spawnApp(appPath, [\"--no-sandbox\"], true, { DISPLAY: display })\n      }\n      break\n    }\n\n    default:\n      throw new Error(`Unsupported platform: ${platform}`)\n  }\n\n  return new Promise((resolve, reject) => {\n    let version: string | undefined\n    let resolved = false\n    const stdoutChunks: string[] = []\n    const stderrChunks: string[] = []\n\n    function resolveResult(code: number | null) {\n      resolve({\n        version,\n        exitCode: code,\n        stdout: stdoutChunks.join(\"\"),\n        stderr: stderrChunks.join(\"\"),\n      })\n    }\n\n    child.stdout?.on(\"data\", data => {\n      const line = data.toString()\n      console.log(line)\n      stdoutChunks.push(line)\n      const match = line.match(versionRegex)\n      if (match) {\n        version = match[1].trim()\n        console.log(`Found Version in console logs: ${version}`)\n        if (expectedVersion && version !== expectedVersion) {\n          reject(new Error(`Expected version ${expectedVersion}, got ${version}`))\n        } else {\n          resolved = true\n          resolveResult(0)\n        }\n      }\n    })\n\n    child.stderr?.on(\"data\", data => {\n      const line = data.toString()\n      stderrChunks.push(line)\n      console.error(`[stderr] ${line}`)\n    })\n\n    child.on(\"error\", err => {\n      if (!resolved) {\n        resolved = true\n        reject(err)\n      }\n    })\n\n    child.on(\"exit\", code => {\n      if (!resolved) {\n        resolved = true\n        resolveResult(code)\n      }\n    })\n\n    setTimeout(() => {\n      if (!resolved) {\n        resolved = true\n        child.kill()\n        reject(new Error(`Timeout after ${timeoutMs}ms\\nSTDOUT:\\n${stdoutChunks.join(\"\")}\\nSTDERR:\\n${stderrChunks.join(\"\")}`))\n      }\n    }, timeoutMs)\n  })\n}\n\n// ⬇️ Launch Xvfb and validate it starts\nexport function startXvfb(): { display: string; stop: () => void } {\n  const display = `:${Math.ceil(Math.random() * 100)}`\n  const proc = spawn(\"Xvfb\", [display, \"-screen\", \"0\", \"1920x1080x24\"], {\n    detached: true,\n    stdio: [\"ignore\", \"pipe\", \"pipe\"],\n  })\n\n  let errorOutput = \"\"\n  proc.stderr?.on(\"data\", data => {\n    errorOutput += data.toString()\n  })\n\n  setTimeout(() => {\n    if (!proc.pid || isNaN(proc.pid)) {\n      throw new Error(`Xvfb failed to start on ${display}: ${errorOutput}`)\n    }\n  }, 1000)\n\n  proc.unref()\n\n  const stop = () => {\n    console.log(`Stopping Xvfb.${isEmptyOrSpaces(errorOutput) ? \"\" : ` Error output: ${errorOutput}`}`)\n    if (typeof proc.pid === \"number\" && !isNaN(proc.pid)) {\n      try {\n        process.kill(-proc.pid, \"SIGTERM\")\n      } catch (e) {\n        console.warn(\"Failed to stop Xvfb:\", e)\n      }\n    }\n  }\n  // Ensure Xvfb is stopped on main process exit\n  ;[\"SIGINT\", \"SIGTERM\", \"uncaughtException\", \"unhandledRejection\"].forEach(sig => {\n    process.once(sig, () => {\n      try {\n        stop()\n      } catch (e) {\n        console.warn(\"Failed to stop Xvfb:\", e)\n      }\n    })\n  })\n\n  console.log(\"Xvfb started on display\", display)\n  return {\n    display,\n    stop,\n  }\n}\n"]}