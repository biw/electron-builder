{"version":3,"file":"blackboxUpdateTest.js","sourceRoot":"","sources":["../../src/updater/blackboxUpdateTest.ts"],"names":[],"mappings":"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","sourcesContent":["import { getBinFromUrl } from \"app-builder-lib/out/binDownload\"\nimport { GenericServerOptions, Nullish } from \"builder-util-runtime\"\nimport { archFromString, doSpawn, getArchSuffix, isEmptyOrSpaces, log, TmpDir } from \"builder-util/out/util\"\nimport { Arch, Configuration, Platform } from \"electron-builder\"\nimport fs, { existsSync, outputFile } from \"fs-extra\"\nimport path from \"path\"\nimport { afterAll, beforeAll, describe, ExpectStatic, TestContext } from \"vitest\"\nimport { launchAndWaitForQuit } from \"../helpers/launchAppCrossPlatform\"\nimport { assertPack, modifyPackageJson, PackedContext } from \"../helpers/packTester\"\nimport { ELECTRON_VERSION } from \"../helpers/testConfig\"\nimport { NEW_VERSION_NUMBER, OLD_VERSION_NUMBER, writeUpdateConfig } from \"../helpers/updaterTestUtil\"\nimport { execFileSync, execSync } from \"child_process\"\nimport { homedir } from \"os\"\nimport { DebUpdater, PacmanUpdater, RpmUpdater } from \"electron-updater\"\n\n// Linux Tests MUST be run in docker containers for proper ephemeral testing environment (e.g. fresh install + update + relaunch)\n// Currently this test logic does not handle uninstalling packages (yet)\ndescribe(\"Electron autoupdate (fresh install & update)\", () => {\n  beforeAll(() => {\n    process.env.AUTO_UPDATER_TEST = \"1\"\n  })\n  afterAll(() => {\n    delete process.env.AUTO_UPDATER_TEST\n  })\n\n  // Signing is required for macOS autoupdate\n  test.ifMac.ifEnv(process.env.CSC_KEY_PASSWORD)(\"mac\", async context => {\n    await runTest(context, \"mac\", \"zip\")\n  })\n\n  test.ifWindows(\"win\", async context => {\n    await runTest(context, \"nsis\", \"nsis\")\n  })\n\n  // must be sequential in order for process.env.ELECTRON_BUILDER_LINUX_PACKAGE_MANAGER to be respected per-test\n  describe.runIf(process.platform === \"linux\")(\"linux\", { sequential: true }, () => {\n    test.ifEnv(process.env.RUN_APP_IMAGE_TEST === \"true\" && process.arch === \"arm64\")(\"AppImage - arm64\", async context => {\n      await runTest(context, \"AppImage\", \"appimage\", Arch.arm64)\n    })\n\n    // only works on x64, so this will fail on arm64 macs due to arch mismatch\n    test.ifEnv(process.env.RUN_APP_IMAGE_TEST === \"true\" && process.arch === \"x64\")(\"AppImage - x64\", async context => {\n      await runTest(context, \"AppImage\", \"appimage\", Arch.x64)\n    })\n\n    // package manager tests specific to each distro (and corresponding docker image)\n    for (const distro in packageManagerMap) {\n      const { pms, target } = packageManagerMap[distro as keyof typeof packageManagerMap]\n      for (const pm of pms) {\n        test(`${distro} - (${pm})`, { sequential: true }, async context => {\n          if (!determineEnvironment(distro)) {\n            context.skip()\n          }\n          // skip if already set to avoid interfering with other package manager tests\n          if (!isEmptyOrSpaces(process.env.PACKAGE_MANAGER_TO_TEST) && process.env.PACKAGE_MANAGER_TO_TEST !== pm) {\n            context.skip()\n          }\n          await runTest(context, target, pm, Arch.x64)\n        })\n      }\n    }\n  })\n})\n\nconst determineEnvironment = (target: string) => {\n  return execSync(`cat /etc/*release | grep \"^ID=\"`).toString().includes(target)\n}\n\nconst packageManagerMap: {\n  [key: string]: {\n    pms: string[]\n    target: string\n  }\n} = {\n  fedora: {\n    pms: [\"zypper\", \"dnf\", \"yum\", \"rpm\"],\n    target: \"rpm\",\n  },\n  debian: {\n    pms: [\"apt\", \"dpkg\"],\n    target: \"deb\",\n  },\n  arch: {\n    pms: [\"pacman\"],\n    target: \"pacman\",\n  },\n}\n\nasync function runTest(context: TestContext, target: string, packageManager: string, arch: Arch = Arch.x64) {\n  const { expect } = context\n\n  const tmpDir = new TmpDir(\"auto-update\")\n  const outDirs: ApplicationUpdatePaths[] = []\n  await doBuild(expect, outDirs, Platform.current().createTarget([target], arch), tmpDir, process.platform === \"win32\")\n\n  const oldAppDir = outDirs[0]\n  const newAppDir = outDirs[1]\n\n  const dirPath = oldAppDir.dir\n  // Setup tests by installing the previous version\n  const appPath = await handleInitialInstallPerOS({ target, dirPath, arch })\n\n  if (!existsSync(appPath)) {\n    throw new Error(`App not found: ${appPath}`)\n  }\n\n  let queuedError: Error | null = null\n  try {\n    await runTestWithinServer(async (rootDirectory: string, updateConfigPath: string) => {\n      // Move app update to the root directory of the server\n      await fs.copy(newAppDir.dir, rootDirectory, { recursive: true, overwrite: true })\n\n      const verifyAppVersion = async (expectedVersion: string) =>\n        await launchAndWaitForQuit({ appPath, timeoutMs: 2 * 60 * 1000, updateConfigPath, expectedVersion, packageManagerToTest: packageManager })\n\n      const result = await verifyAppVersion(OLD_VERSION_NUMBER)\n      log.debug(result, \"Test App version\")\n      expect(result.version).toMatch(OLD_VERSION_NUMBER)\n\n      // Wait for quitAndInstall to take effect, increase delay if updates are slower\n      // (shouldn't be the case for such a small test app, but Windows with Debugger attached is pretty dam slow)\n      const delay = 60 * 1000\n      await new Promise(resolve => setTimeout(resolve, delay))\n\n      expect((await verifyAppVersion(NEW_VERSION_NUMBER)).version).toMatch(NEW_VERSION_NUMBER)\n    })\n  } catch (error: any) {\n    log.error({ error: error.message }, \"Blackbox Updater Test failed to run\")\n    queuedError = error\n  } finally {\n    // windows needs to release file locks, so a delay seems to be needed\n    await new Promise(resolve => setTimeout(resolve, 1000))\n    await tmpDir.cleanup()\n    try {\n      await handleCleanupPerOS({ target })\n    } catch (error: any) {\n      log.error({ error: error.message }, \"Blackbox Updater Test cleanup failed\")\n      // ignore\n    }\n  }\n  if (queuedError) {\n    throw queuedError\n  }\n}\n\ntype ApplicationUpdatePaths = {\n  dir: string\n  appPath: string\n}\n\nasync function doBuild(\n  expect: ExpectStatic,\n  outDirs: Array<ApplicationUpdatePaths>,\n  targets: Map<Platform, Map<Arch, Array<string>>>,\n  tmpDir: TmpDir,\n  isWindows: boolean,\n  extraConfig?: Configuration | null\n) {\n  async function buildApp(\n    version: string,\n    targets: Map<Platform, Map<Arch, Array<string>>>,\n    extraConfig: Configuration | Nullish,\n    packed: (context: PackedContext) => Promise<any>\n  ) {\n    await assertPack(\n      expect,\n      \"test-app\",\n      {\n        targets,\n        config: {\n          productName: \"TestApp\",\n          executableName: \"TestApp\",\n          appId: \"com.test.app\",\n          artifactName: \"${productName}.${ext}\",\n          // asar: false, // not necessarily needed, just easier debugging tbh\n          electronLanguages: [\"en\"],\n          extraMetadata: {\n            name: \"testapp\",\n            version,\n          },\n          ...extraConfig,\n          compression: \"store\",\n          publish: {\n            provider: \"s3\",\n            bucket: \"develar\",\n            path: \"test\",\n          },\n          files: [\"**/*\", \"../**/node_modules/**\", \"!path/**\"],\n          nsis: {\n            artifactName: \"${productName} Setup.${ext}\",\n            // one click installer required. don't run after install otherwise we lose stdout pipe\n            oneClick: true,\n            runAfterFinish: false,\n          },\n        },\n      },\n      {\n        storeDepsLockfileSnapshot: false,\n        signed: true,\n        signedWin: isWindows,\n        packed,\n        projectDirCreated: async projectDir => {\n          await Promise.all([\n            outputFile(path.join(projectDir, \"package-lock.json\"), \"{}\"),\n            outputFile(path.join(projectDir, \".npmrc\"), \"node-linker=hoisted\"),\n            modifyPackageJson(\n              projectDir,\n              data => {\n                data.devDependencies = {\n                  electron: ELECTRON_VERSION,\n                }\n                data.dependencies = {\n                  ...data.dependencies,\n                  \"@electron/remote\": \"^2.1.2\", // for debugging live application with GUI so that app.getVersion is accessible in renderer process\n                  \"electron-updater\": `file:${__dirname}/../../../packages/electron-updater`,\n                }\n                data.pnpm = {\n                  overrides: {\n                    \"builder-util-runtime\": `file:${__dirname}/../../../packages/builder-util-runtime`,\n                  },\n                }\n              },\n              true\n            ),\n            modifyPackageJson(\n              projectDir,\n              data => {\n                data.devDependencies = {\n                  electron: ELECTRON_VERSION,\n                }\n                data.dependencies = {\n                  ...data.dependencies,\n                  \"@electron/remote\": \"^2.1.2\", // for debugging live application with GUI so that app.getVersion is accessible in renderer process\n                  \"electron-updater\": `file:${__dirname}/../../../packages/electron-updater`,\n                }\n                data.pnpm = {\n                  overrides: {\n                    \"builder-util-runtime\": `file:${__dirname}/../../../packages/builder-util-runtime`,\n                  },\n                }\n              },\n              false\n            ),\n          ])\n          execSync(\"npm install\", { cwd: projectDir, stdio: \"inherit\" })\n        },\n      }\n    )\n  }\n\n  const build = (version: string) =>\n    buildApp(version, targets, extraConfig, async context => {\n      // move dist temporarily out of project dir so each downloader can reference it\n      const dir = await tmpDir.getTempDir({ prefix: version })\n      await fs.move(context.outDir, dir)\n      const appPath = path.join(dir, path.relative(context.outDir, context.getAppPath(Platform.current(), archFromString(process.arch))))\n      outDirs.push({ dir, appPath })\n    })\n  try {\n    await build(OLD_VERSION_NUMBER)\n    await build(NEW_VERSION_NUMBER)\n  } catch (e: any) {\n    await tmpDir.cleanup()\n    throw e\n  }\n}\n\nasync function handleInitialInstallPerOS({ target, dirPath, arch }: { target: string; dirPath: string; arch: Arch }): Promise<string> {\n  let appPath: string\n  if (target === \"AppImage\") {\n    appPath = path.join(dirPath, `TestApp.AppImage`)\n  } else if (target === \"deb\") {\n    DebUpdater.installWithCommandRunner(\n      \"dpkg\",\n      path.join(dirPath, `TestApp.deb`),\n      commandWithArgs => {\n        execSync(commandWithArgs.join(\" \"), { stdio: \"inherit\" })\n      },\n      console\n    )\n    appPath = path.join(\"/opt\", \"TestApp\", \"TestApp\")\n  } else if (target === \"rpm\") {\n    RpmUpdater.installWithCommandRunner(\n      \"zypper\",\n      path.join(dirPath, `TestApp.rpm`),\n      commandWithArgs => {\n        execSync(commandWithArgs.join(\" \"), { stdio: \"inherit\" })\n      },\n      console\n    )\n    appPath = path.join(\"/opt\", \"TestApp\", \"TestApp\")\n  } else if (target === \"pacman\") {\n    PacmanUpdater.installWithCommandRunner(\n      path.join(dirPath, `TestApp.pacman`),\n      commandWithArgs => {\n        execSync(commandWithArgs.join(\" \"), { stdio: \"inherit\" })\n      },\n      console\n    )\n    // execSync(`sudo pacman -Syyu --noconfirm`, { stdio: \"inherit\" })\n    // execSync(`sudo pacman -U --noconfirm \"${path.join(dirPath, `TestApp.pacman`)}\"`, { stdio: \"inherit\" })\n    appPath = path.join(\"/opt\", \"TestApp\", \"TestApp\")\n  } else if (process.platform === \"win32\") {\n    // access installed app's location\n    const localProgramsPath = path.join(process.env.LOCALAPPDATA || path.join(homedir(), \"AppData\", \"Local\"), \"Programs\", \"TestApp\")\n    // this is to clear dev environment when not running on an ephemeral GH runner.\n    // Reinstallation will otherwise fail due to \"uninstall\" message prompt, so we must uninstall first (hence the setTimeout delay)\n    const uninstaller = path.join(localProgramsPath, \"Uninstall TestApp.exe\")\n    if (existsSync(uninstaller)) {\n      console.log(\"Uninstalling\", uninstaller)\n      execFileSync(uninstaller, [\"/S\", \"/C\", \"exit\"], { stdio: \"inherit\" })\n      await new Promise(resolve => setTimeout(resolve, 5000))\n    }\n\n    const installerPath = path.join(dirPath, \"TestApp Setup.exe\")\n    console.log(\"Installing windows\", installerPath)\n    // Don't use /S for silent install as we lose stdout pipe\n    execFileSync(installerPath, [\"/S\"], { stdio: \"inherit\" })\n\n    appPath = path.join(localProgramsPath, \"TestApp.exe\")\n  } else if (process.platform === \"darwin\") {\n    appPath = path.join(dirPath, `mac${getArchSuffix(arch)}`, `TestApp.app`, \"Contents\", \"MacOS\", \"TestApp\")\n  } else {\n    throw new Error(`Unsupported Update test target: ${target}`)\n  }\n  return appPath\n}\n\nasync function handleCleanupPerOS({ target }: { target: string }) {\n  // TODO: ignore for now, this doesn't block CI, but proper uninstall logic should be implemented\n  if (target === \"deb\") {\n    //   execSync(\"dpkg -r testapp\", { stdio: \"inherit\" });\n  } else if (target === \"rpm\") {\n    // execSync(`zypper rm -y testapp`, { stdio: \"inherit\" })\n  } else if (target === \"pacman\") {\n    execSync(`pacman -R --noconfirm testapp`, { stdio: \"inherit\" })\n  } else if (process.platform === \"win32\") {\n    // access installed app's location\n    const localProgramsPath = path.join(process.env.LOCALAPPDATA || path.join(homedir(), \"AppData\", \"Local\"), \"Programs\", \"TestApp\")\n    const uninstaller = path.join(localProgramsPath, \"Uninstall TestApp.exe\")\n    console.log(\"Uninstalling\", uninstaller)\n    execFileSync(uninstaller, [\"/S\", \"/C\", \"exit\"], { stdio: \"inherit\" })\n    await new Promise(resolve => setTimeout(resolve, 5000))\n  } else if (process.platform === \"darwin\") {\n    // ignore, nothing to uninstall, it's running/updating out of the local `dist` directory\n  }\n}\n\nasync function runTestWithinServer(doTest: (rootDirectory: string, updateConfigPath: string) => Promise<void>) {\n  const tmpDir = new TmpDir(\"blackbox-update-test\")\n  const root = await tmpDir.createTempDir({ prefix: \"server-root\" })\n\n  // 65535 is the max port number\n  // Math.random() / Math.random() is used to avoid zero\n  // Math.floor(((Math.random() / Math.random()) * 1000) % 65535) is used to avoid port number collision\n  const port = 8000 + Math.floor(((Math.random() / Math.random()) * 1000) % 65535)\n  const serverBin = await getBinFromUrl(\"ran-0.1.3\", \"ran-0.1.3.7z\", \"imfA3LtT6umMM0BuQ29MgO3CJ9uleN5zRBi3sXzcTbMOeYZ6SQeN7eKr3kXZikKnVOIwbH+DDO43wkiR/qTdkg==\")\n  const httpServerProcess = doSpawn(path.join(serverBin, process.platform, \"ran\"), [`-root=${root}`, `-port=${port}`, \"-gzip=false\", \"-listdir=true\"])\n\n  const updateConfig = await writeUpdateConfig<GenericServerOptions>({\n    provider: \"generic\",\n    url: `http://127.0.0.1:${port}`,\n  })\n\n  const cleanup = () => {\n    try {\n      tmpDir.cleanupSync()\n    } catch (error) {\n      console.error(\"Failed to cleanup tmpDir\", error)\n    }\n    try {\n      httpServerProcess.kill()\n    } catch (error) {\n      console.error(\"Failed to kill httpServerProcess\", error)\n    }\n  }\n\n  return await new Promise<void>((resolve, reject) => {\n    httpServerProcess.on(\"error\", reject)\n    doTest(root, updateConfig).then(resolve).catch(reject)\n  }).then(\n    v => {\n      cleanup()\n      return v\n    },\n    e => {\n      cleanup()\n      throw e\n    }\n  )\n}\n"]}