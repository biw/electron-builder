{"version":3,"file":"verifySmartUnpack.js","sourceRoot":"","sources":["../../src/helpers/verifySmartUnpack.ts"],"names":[],"mappings":";;AAOA,4DAiBC;AAED,8CAmBC;AA7CD,wDAAwE;AACxE,+CAAmC;AACnC,2BAAiC;AACjC,6BAA4B;AAC5B,6CAAsD;AAGtD,SAAgB,wBAAwB,CAAC,IAAS;IAChD,OAAO,IAAI,CAAC,KAAK,CACf,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE;QACnC,IAAI,IAAI,KAAK,QAAQ,EAAE,CAAC;YACtB,OAAO,SAAS,CAAA;QAClB,CAAC;QACD,IAAI,KAAK,CAAC,IAAI,IAAI,IAAI,EAAE,CAAC;YACvB,yIAAyI;YACzI,KAAK,CAAC,IAAI,GAAG,QAAQ,CAAA;QACvB,CAAC;QACD,8BAA8B;QAC9B,IAAI,KAAK,CAAC,SAAS,EAAE,CAAC;YACpB,OAAO,KAAK,CAAC,SAAS,CAAA;QACxB,CAAC;QACD,OAAO,KAAK,CAAA;IACd,CAAC,CAAC,CACH,CAAA;AACH,CAAC;AAEM,KAAK,UAAU,iBAAiB,CAAC,MAAoB,EAAE,WAAmB,EAAE,uBAAmE;IACpJ,MAAM,MAAM,GAAG,MAAM,IAAA,eAAQ,EAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,UAAU,CAAC,CAAC,CAAA;IACjE,MAAM,CAAC,MAAM,MAAM,CAAC,QAAQ,CAAC,eAAe,IAAI,CAAC,GAAG,QAAQ,IAAI,CAAC,GAAG,cAAc,CAAC,CAAC,CAAC,aAAa,CAAC;QACjG,IAAI,EAAE,OAAO;KACd,CAAC,CAAA;IAEF,4DAA4D;IAC5D,MAAM,CAAA,uBAAuB,aAAvB,uBAAuB,uBAAvB,uBAAuB,CAAG,MAAM,CAAC,CAAA,CAAA;IAEvC,MAAM,CAAC,wBAAwB,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,eAAe,EAAE,CAAA;IAEjE,MAAM,KAAK,GAAG,CAAC,MAAM,IAAA,mBAAI,EAAC,WAAW,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,YAAY,IAAI,CAAC,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE;QAChJ,MAAM,IAAI,GAAG,IAAA,oCAAuB,EAAC,EAAE,CAAC,SAAS,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAA;QAC1E,IAAI,EAAE,CAAC,QAAQ,CAAC,cAAc,CAAC,EAAE,CAAC;YAChC,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,IAAA,iBAAY,EAAC,EAAE,EAAE,OAAO,CAAC,EAAE,CAAA;QACrD,CAAC;QACD,OAAO,IAAI,CAAA;IACb,CAAC,CAAC,CAAA;IACF,MAAM,CAAC,KAAK,CAAC,CAAC,eAAe,EAAE,CAAA;AACjC,CAAC","sourcesContent":["import { AsarFilesystem, readAsar } from \"app-builder-lib/out/asar/asar\"\nimport { walk } from \"builder-util\"\nimport { readFileSync } from \"fs\"\nimport * as path from \"path\"\nimport { toSystemIndependentPath } from \"./packTester\"\nimport { ExpectStatic } from \"vitest\"\n\nexport function removeUnstableProperties(data: any) {\n  return JSON.parse(\n    JSON.stringify(data, (name, value) => {\n      if (name === \"offset\") {\n        return undefined\n      }\n      if (value.size != null) {\n        // size differs on various OS and subdependencies aren't pinned, so this will randomly fail when subdependency resolution versions change\n        value.size = \"<size>\"\n      }\n      // Keep existing test coverage\n      if (value.integrity) {\n        delete value.integrity\n      }\n      return value\n    })\n  )\n}\n\nexport async function verifySmartUnpack(expect: ExpectStatic, resourceDir: string, additionalVerifications?: (asarFs: AsarFilesystem) => Promise<void>) {\n  const asarFs = await readAsar(path.join(resourceDir, \"app.asar\"))\n  expect(await asarFs.readJson(`node_modules${path.sep}debug${path.sep}package.json`)).toMatchObject({\n    name: \"debug\",\n  })\n\n  // For verifying additional files within the Asar Filesystem\n  await additionalVerifications?.(asarFs)\n\n  expect(removeUnstableProperties(asarFs.header)).toMatchSnapshot()\n\n  const files = (await walk(resourceDir, file => !path.basename(file).startsWith(\".\") && !file.endsWith(`resources${path.sep}inspector`))).map(it => {\n    const name = toSystemIndependentPath(it.substring(resourceDir.length + 1))\n    if (it.endsWith(\"package.json\")) {\n      return { name, content: readFileSync(it, \"utf-8\") }\n    }\n    return name\n  })\n  expect(files).toMatchSnapshot()\n}\n"]}