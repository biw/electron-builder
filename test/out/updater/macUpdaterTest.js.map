{"version":3,"file":"macUpdaterTest.js","sourceRoot":"","sources":["../../src/updater/macUpdaterTest.ts"],"names":[],"mappings":";;AAAA,+DAAoF;AACpF,gEAA4D;AAC5D,mCAAqC;AACrC,sDAAkD;AAClD,gEAAgI;AAChI,+DAAyD;AAEzD,MAAM,iBAAkB,SAAQ,qBAAY;IAA5C;;QACU,cAAS,GAAkB,IAAI,CAAA;IAoBzC,CAAC;IAlBC,mCAAmC;IACnC,eAAe;QACb,OAAO,CAAC,GAAG,CAAC,mCAAmC,CAAC,CAAA;QAChD,IAAI,CAAC,QAAQ,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE;YAC5B,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAA;QAC3B,CAAC,CAAC,CAAA;IACJ,CAAC;IAEO,KAAK,CAAC,QAAQ;QACpB,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,MAAM,8BAAY,CAAC,OAAO,CAAC,IAAA,qDAA8B,EAAC,IAAI,CAAC,SAAU,EAAE,EAAE,CAAC,CAAC,CAAE,CAAC,CAAA;QAC3G,MAAM,8BAAY,CAAC,OAAO,CAAC,IAAA,qDAA8B,EAAC,IAAI,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,CAAA;IAC1E,CAAC;IAED,mCAAmC;IACnC,UAAU,CAAC,SAAc;QACvB,2DAA2D;QAC3D,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC,GAAG,CAAA;IAChC,CAAC;CACF;AAED,IAAI,CAAC,KAAK,CAAC,aAAa,EAAE,KAAK,EAAE,EAAE,MAAM,EAAE,EAAE,EAAE;IAC7C,MAAM,iBAAiB,GAAG,IAAI,iBAAiB,EAAE,CAAA;IAEjD,IAAA,yCAAkB,EAAC,UAAU,EAAE;QAC7B,WAAW,EAAE,iBAAiB;KAC/B,CAAC,CAAA;IAEF,MAAM,OAAO,GAAG,IAAI,uBAAU,CAAC,SAAS,EAAE,MAAM,IAAA,sCAAoB,GAAE,CAAC,CAAA;IACvE,MAAM,OAAO,GAAkB;QAC7B,QAAQ,EAAE,QAAQ;QAClB,KAAK,EAAE,SAAS;QAChB,IAAI,EAAE,uBAAuB;KAC9B,CAAA;IACD,OAAO,CAAC,gBAAgB,GAAG,MAAM,IAAA,mCAAiB,EAAC,OAAO,CAAC,CAAA;IAE3D,OAAO,CAAC,EAAE,CAAC,mBAAmB,EAAE,GAAG,EAAE;QACnC,oCAAoC;IACtC,CAAC,CAAC,CAAA;IAEF,IAAA,iCAAe,EAAC,OAAO,CAAC,CACvB;IAAC,OAAe,CAAC,gBAAgB,CAAC,QAAQ,GAAG,OAAO,CAAC,QAAQ,CAAA;IAC9D,MAAM,YAAY,GAAG,IAAA,6BAAW,EAAC,OAAO,CAAC,CAAA;IAEzC,MAAM,iBAAiB,GAAG,MAAM,OAAO,CAAC,eAAe,EAAE,CAAA;IACzD,yCAAyC;IACzC,0FAA0F;IAC1F,MAAM,KAAK,GAAG,MAAM,CAAA,iBAAiB,aAAjB,iBAAiB,uBAAjB,iBAAiB,CAAE,eAAe,CAAA,CAAA;IACtD,MAAM,CAAC,KAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAA;IAChC,MAAM,IAAA,uBAAU,EAAC,MAAM,EAAE,KAAM,CAAC,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,CAAA;IAC5C,MAAM,CAAC,YAAY,CAAC,CAAC,eAAe,EAAE,CAAA;AACxC,CAAC,CAAC,CAAA","sourcesContent":["import { configureRequestOptionsFromUrl, GithubOptions } from \"builder-util-runtime\"\nimport { MacUpdater } from \"electron-updater/out/MacUpdater\"\nimport { EventEmitter } from \"events\"\nimport { assertThat } from \"../helpers/fileAssert\"\nimport { createTestAppAdapter, httpExecutor, trackEvents, tuneTestUpdater, writeUpdateConfig } from \"../helpers/updaterTestUtil\"\nimport { mockForNodeRequire } from \"vitest-mock-commonjs\"\n\nclass TestNativeUpdater extends EventEmitter {\n  private updateUrl: string | null = null\n\n  // noinspection JSMethodCanBeStatic\n  checkForUpdates() {\n    console.log(\"TestNativeUpdater.checkForUpdates\")\n    this.download().catch(error => {\n      this.emit(\"error\", error)\n    })\n  }\n\n  private async download() {\n    const data = JSON.parse((await httpExecutor.request(configureRequestOptionsFromUrl(this.updateUrl!, {})))!)\n    await httpExecutor.request(configureRequestOptionsFromUrl(data.url, {}))\n  }\n\n  // noinspection JSMethodCanBeStatic\n  setFeedURL(updateUrl: any) {\n    // console.log(\"TestNativeUpdater.setFeedURL \" + updateUrl)\n    this.updateUrl = updateUrl.url\n  }\n}\n\ntest.ifMac(\"mac updates\", async ({ expect }) => {\n  const mockNativeUpdater = new TestNativeUpdater()\n\n  mockForNodeRequire(\"electron\", {\n    autoUpdater: mockNativeUpdater,\n  })\n\n  const updater = new MacUpdater(undefined, await createTestAppAdapter())\n  const options: GithubOptions = {\n    provider: \"github\",\n    owner: \"develar\",\n    repo: \"onshape-desktop-shell\",\n  }\n  updater.updateConfigPath = await writeUpdateConfig(options)\n\n  updater.on(\"download-progress\", () => {\n    // console.log(JSON.stringify(data))\n  })\n\n  tuneTestUpdater(updater)\n  ;(updater as any)._testOnlyOptions.platform = process.platform\n  const actualEvents = trackEvents(updater)\n\n  const updateCheckResult = await updater.checkForUpdates()\n  // todo when will be updated to use files\n  // expect(removeUnstableProperties(updateCheckResult?.updateInfo.files)).toMatchSnapshot()\n  const files = await updateCheckResult?.downloadPromise\n  expect(files!.length).toEqual(1)\n  await assertThat(expect, files![0]).isFile()\n  expect(actualEvents).toMatchSnapshot()\n})\n"]}