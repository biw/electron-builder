{"version":3,"file":"msiWrappedTest.js","sourceRoot":"","sources":["../../src/windows/msiWrappedTest.ts"],"names":[],"mappings":"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","sourcesContent":["import { Platform } from \"electron-builder\"\nimport { XMLParser } from \"fast-xml-parser\"\nimport * as fs from \"fs\"\nimport { app, appThrows } from \"../helpers/packTester\"\n\nconst parser = new XMLParser({\n  ignoreAttributes: false,\n  ignoreDeclaration: true,\n  parseTagValue: true,\n})\n\ntest.ifDevOrWinCi(\"msiWrapped requires nsis\", ({ expect }) =>\n  appThrows(\n    expect,\n    {\n      targets: Platform.WINDOWS.createTarget(\"msiWrapped\"),\n      config: {\n        appId: \"build.electron.test.msi.oneClick.perMachine\",\n        extraMetadata: {\n          // version: \"1.0.0\",\n        },\n        productName: \"Test MSI\",\n        win: {\n          target: [\"msiWrapped\"],\n        },\n        electronFuses: {\n          runAsNode: true,\n          enableCookieEncryption: true,\n          enableNodeOptionsEnvironmentVariable: true,\n          enableNodeCliInspectArguments: true,\n          enableEmbeddedAsarIntegrityValidation: true,\n          onlyLoadAppFromAsar: true,\n          loadBrowserProcessSpecificV8Snapshot: true,\n          grantFileProtocolExtraPrivileges: undefined, // unsupported on current electron version in our tests\n        },\n      },\n    },\n    {},\n    error => {\n      expect(error).toBeInstanceOf(Error)\n      expect(error.message).toBe(\"No nsis target found! Please specify an nsis target\")\n    }\n  )\n)\n\ntest.ifDevOrWinCi(\"msiWrapped allows capitalized nsis target\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.WINDOWS.createTarget([\"msiWrapped\", \"NSIS\"]),\n      config: {\n        appId: \"build.electron.test.msi.oneClick.perMachine\",\n        extraMetadata: {\n          // version: \"1.0.0\",\n        },\n        productName: \"Test MSI\",\n        win: {\n          target: [\"msiWrapped\", \"NSIS\"],\n        },\n      },\n    },\n    {}\n  )\n)\n\ntest.ifDevOrWinCi(\"msiWrapped includes packaged exe\", ({ expect }) =>\n  app(expect, {\n    targets: Platform.WINDOWS.createTarget([\"msiWrapped\", \"nsis\"]),\n    config: {\n      appId: \"build.electron.test.msi.oneClick.perMachine\",\n      extraMetadata: {\n        // version: \"1.0.0\",\n      },\n      productName: \"MSIWrappingEXE\",\n      win: {\n        target: [\"msiWrapped\", \"nsis\"],\n      },\n      msiProjectCreated: async path => {\n        const msiContents = await fs.promises.readFile(path, \"utf8\")\n\n        const contents = parser.parse(msiContents)\n\n        expect(contents[\"Wix\"][\"Product\"][\"Binary\"][\"@_SourceFile\"]).toMatch(/^.*\\.(exe|EXE)/)\n        expect(contents[\"Wix\"][\"Product\"][\"InstallExecuteSequence\"]).toBeTruthy()\n      },\n    },\n  })\n)\n\ntest.ifDevOrWinCi(\"msiWrapped impersonate no if not provided\", ({ expect }) =>\n  app(expect, {\n    targets: Platform.WINDOWS.createTarget([\"msiWrapped\", \"nsis\"]),\n    config: {\n      appId: \"build.electron.test.msi.oneClick.perMachine\",\n      extraMetadata: {\n        // version: \"1.0.0\",\n      },\n      productName: \"MSIWrappingEXE\",\n      win: {\n        target: [\"msiWrapped\", \"nsis\"],\n      },\n      msiProjectCreated: async path => {\n        const msiContents = await fs.promises.readFile(path, \"utf8\")\n\n        const contents = parser.parse(msiContents)\n\n        expect(contents[\"Wix\"][\"Product\"][\"CustomAction\"][\"@_Impersonate\"]).toEqual(\"no\")\n      },\n    },\n  })\n)\n\ntest.ifDevOrWinCi(\"msiWrapped impersonate yes if true\", ({ expect }) =>\n  app(expect, {\n    targets: Platform.WINDOWS.createTarget([\"msiWrapped\", \"nsis\"]),\n    config: {\n      appId: \"build.electron.test.msi.oneClick.perMachine\",\n      extraMetadata: {\n        // version: \"1.0.0\",\n      },\n      productName: \"MSIWrappingEXE\",\n      win: {\n        target: [\"msiWrapped\", \"nsis\"],\n      },\n      msiWrapped: {\n        impersonate: true,\n      },\n      msiProjectCreated: async path => {\n        const msiContents = await fs.promises.readFile(path, \"utf8\")\n\n        const contents = parser.parse(msiContents)\n\n        expect(contents[\"Wix\"][\"Product\"][\"CustomAction\"][\"@_Impersonate\"]).toEqual(\"yes\")\n      },\n    },\n  })\n)\n\ntest.ifDevOrWinCi(\"msiWrapped wrappedInstallerArgs provided\", ({ expect }) =>\n  app(expect, {\n    targets: Platform.WINDOWS.createTarget([\"msiWrapped\", \"nsis\"]),\n    config: {\n      appId: \"build.electron.test.msi.oneClick.perMachine\",\n      extraMetadata: {\n        // version: \"1.0.0\",\n      },\n      productName: \"MSIWrappingEXE\",\n      win: {\n        target: [\"msiWrapped\", \"nsis\"],\n      },\n      msiWrapped: {\n        wrappedInstallerArgs: \"/currentuser /S /wut\",\n      },\n      msiProjectCreated: async path => {\n        const msiContents = await fs.promises.readFile(path, \"utf8\")\n\n        const contents = parser.parse(msiContents)\n\n        expect(contents[\"Wix\"][\"Product\"][\"CustomAction\"][\"@_ExeCommand\"]).toEqual(\"/currentuser /S /wut\")\n      },\n    },\n  })\n)\n"]}