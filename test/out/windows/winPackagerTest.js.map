{"version":3,"file":"winPackagerTest.js","sourceRoot":"","sources":["../../src/windows/winPackagerTest.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, DIR_TARGET, Platform } from \"electron-builder\"\nimport * as fs from \"fs/promises\"\nimport * as path from \"path\"\nimport { CheckingWinPackager } from \"../helpers/CheckingPackager\"\nimport { app, appThrows, assertPack, platform } from \"../helpers/packTester\"\n\ntest(\n  \"beta version\",\n  ({ expect }) =>\n    app(\n      expect,\n      {\n        targets: Platform.WINDOWS.createTarget([\"nsis\"], Arch.x64, Arch.arm64),\n        config: {\n          extraMetadata: {\n            version: \"3.0.0-beta.2\",\n          },\n          nsis: {\n            buildUniversalInstaller: false,\n          },\n        },\n      },\n      {\n        signedWin: true,\n      }\n    ),\n  { retry: 3 }\n)\n\ntest(\"win zip\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.WINDOWS.createTarget([\"zip\"], Arch.x64, Arch.arm64),\n      config: {\n        extraResources: [\n          { from: \"build\", to: \"./\", filter: \"*.asar\" },\n          { from: \"build/subdir\", to: \"./subdir\", filter: \"*.asar\" },\n        ],\n        electronLanguages: \"en\",\n        downloadAlternateFFmpeg: true,\n        electronFuses: {\n          runAsNode: true,\n          enableCookieEncryption: true,\n          enableNodeOptionsEnvironmentVariable: true,\n          enableNodeCliInspectArguments: true,\n          enableEmbeddedAsarIntegrityValidation: true,\n          onlyLoadAppFromAsar: true,\n          loadBrowserProcessSpecificV8Snapshot: true,\n          grantFileProtocolExtraPrivileges: undefined, // unsupported on current electron version in our tests\n        },\n      },\n    },\n    {\n      signed: false,\n      projectDirCreated: async projectDir => {\n        await fs.mkdir(path.join(projectDir, \"build\", \"subdir\"))\n        await fs.copyFile(path.join(projectDir, \"build\", \"extraAsar.asar\"), path.join(projectDir, \"build\", \"subdir\", \"extraAsar2.asar\"))\n      },\n    }\n  ))\n\ntest(\"zip artifactName\", ({ expect }) =>\n  app(\n    expect,\n    {\n      targets: Platform.WINDOWS.createTarget([\"zip\"], Arch.x64),\n      config: {\n        //tslint:disable-next-line:no-invalid-template-strings\n        artifactName: \"${productName}-${version}-${os}-${arch}.${ext}\",\n      },\n    },\n    {\n      signedWin: true,\n    }\n  ))\n\ntest(\"icon < 256\", ({ expect }) =>\n  appThrows(expect, platform(Platform.WINDOWS), {\n    projectDirCreated: projectDir => fs.rename(path.join(projectDir, \"build\", \"incorrect.ico\"), path.join(projectDir, \"build\", \"icon.ico\")),\n  }))\n\ntest(\"icon not an image\", ({ expect }) =>\n  appThrows(expect, platform(Platform.WINDOWS), {\n    projectDirCreated: async projectDir => {\n      const file = path.join(projectDir, \"build\", \"icon.ico\")\n      // because we use hardlinks\n      await fs.unlink(file)\n      await fs.writeFile(file, \"foo\")\n    },\n  }))\n\ntest.ifMac(\"custom icon\", ({ expect }) => {\n  let platformPackager: CheckingWinPackager | null = null\n  return assertPack(\n    expect,\n    \"test-app-one\",\n    {\n      targets: Platform.WINDOWS.createTarget(\"squirrel\", Arch.x64),\n      platformPackagerFactory: packager => (platformPackager = new CheckingWinPackager(packager)),\n      config: {\n        win: {\n          icon: \"customIcon\",\n        },\n      },\n    },\n    {\n      projectDirCreated: projectDir => fs.rename(path.join(projectDir, \"build\", \"icon.ico\"), path.join(projectDir, \"customIcon.ico\")),\n      packed: async context => {\n        expect(await platformPackager!.getIconPath()).toEqual(path.join(context.projectDir, \"customIcon.ico\"))\n      },\n    }\n  )\n})\n\ntest(\"win icon from icns\", ({ expect }) => {\n  let platformPackager: CheckingWinPackager | null = null\n  return app(\n    expect,\n    {\n      targets: Platform.WINDOWS.createTarget(DIR_TARGET, Arch.x64),\n      config: {\n        mac: {\n          icon: \"icons/icon.icns\",\n        },\n      },\n      platformPackagerFactory: packager => (platformPackager = new CheckingWinPackager(packager)),\n    },\n    {\n      projectDirCreated: projectDir =>\n        Promise.all([fs.unlink(path.join(projectDir, \"build\", \"icon.ico\")), fs.rm(path.join(projectDir, \"build\", \"icons\"), { recursive: true, force: true })]),\n      packed: async () => {\n        const file = await platformPackager!.getIconPath()\n        expect(file).toBeDefined()\n      },\n    }\n  )\n})\n"]}